From: CIRCT Team <circt@llvm.org>
Subject: [PATCH] Fix bind instantiation definition lookup

When resolving a bind directive's instantiation definition, look up the
definition directly from the syntax-to-definition map instead of using
the scope-dependent lookup. This ensures we find the definition even
when the bind scope differs from where the definition was declared.

diff --git a/source/ast/Compilation.cpp b/source/ast/Compilation.cpp
index 83af0fe..edbb8de 100644
--- a/source/ast/Compilation.cpp
+++ b/source/ast/Compilation.cpp
@@ -659,7 +659,13 @@ Compilation::DefinitionLookupResult Compilation::getDefinition(
             case SyntaxKind::InterfaceDeclaration:
             case SyntaxKind::ProgramDeclaration: {
                 auto& mds = bindInfo.instantiationDefSyntax->as<ModuleDeclarationSyntax>();
-                result.definition = getDefinition(scope, mds);
+                if (auto it = definitionFromSyntax.find(&mds);
+                    it != definitionFromSyntax.end() && !it->second.empty()) {
+                    // Get the first definition from any scope
+                    result.definition = it->second.begin()->second;
+                }
+                if (!result.definition)
+                    result.definition = getDefinition(scope, mds);
                 if (!result.definition)
                     errorMissingDef(name, scope, sourceRange, diag::UnknownModule);
                 break;
