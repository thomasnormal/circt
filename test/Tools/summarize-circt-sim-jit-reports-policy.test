// RUN: rm -rf %t
// RUN: mkdir -p %t/reports
// RUN: python3 -c "import json,pathlib; p=pathlib.Path(r'%t/reports/a.json'); p.write_text(json.dumps({'jit':{'jit_deopt_processes':[{'process_id':1,'process_name':'llhd_process_1','reason':'unsupported_operation','detail':'prewait_impure:sim.proc.print'},{'process_id':2,'process_name':'llhd_process_2','reason':'missing_thunk','detail':'compile_budget_zero'}]}}, indent=2), encoding='utf-8')"
// RUN: python3 -c "import json,pathlib; p=pathlib.Path(r'%t/reports/b.json'); p.write_text(json.dumps({'jit':{'jit_deopt_processes':[{'process_id':7,'process_name':'llhd_process_7','reason':'unsupported_operation','detail':'first_op:llvm.call'}]}}, indent=2), encoding='utf-8')"
// RUN: printf 'exact:reason:missing_thunk\nexact:reason_detail:unsupported_operation:first_op:llvm.call\n' > %t/allowlist.partial
// RUN: printf 'exact:reason:missing_thunk\nexact:reason_detail:unsupported_operation:first_op:llvm.call\nexact:reason_detail:unsupported_operation:prewait_impure:sim.proc.print\n' > %t/allowlist.full
// RUN: not python3 %S/../../utils/summarize_circt_sim_jit_reports.py %t/reports --allowlist-file %t/allowlist.partial --fail-on-any-non-allowlisted-deopt 2>&1 | FileCheck %s --check-prefix=FAIL_ANY
// RUN: not python3 %S/../../utils/summarize_circt_sim_jit_reports.py %t/reports --allowlist-file %t/allowlist.partial --fail-on-reason unsupported_operation 2>&1 | FileCheck %s --check-prefix=FAIL_REASON
// RUN: not python3 %S/../../utils/summarize_circt_sim_jit_reports.py %t/reports --allowlist-file %t/allowlist.partial --fail-on-reason-detail unsupported_operation:prewait_impure:sim.proc.print 2>&1 | FileCheck %s --check-prefix=FAIL_DETAIL
// RUN: python3 %S/../../utils/summarize_circt_sim_jit_reports.py %t/reports --allowlist-file %t/allowlist.full --fail-on-any-non-allowlisted-deopt --fail-on-reason unsupported_operation --fail-on-reason-detail unsupported_operation:prewait_impure:sim.proc.print > %t/log.txt 2>&1
// RUN: FileCheck %s --check-prefix=PASS < %t/log.txt
//
// FAIL_ANY: deopt_process_rows_non_allowlisted=1
// FAIL_ANY: non-allowlisted deopts present: rows=1
//
// FAIL_REASON: top_non_allowlisted_reason[1] reason=unsupported_operation count=1
// FAIL_REASON: blocked reason matched: reason=unsupported_operation count=1
//
// FAIL_DETAIL: top_non_allowlisted_reason_detail[1] reason=unsupported_operation detail=prewait_impure:sim.proc.print count=1
// FAIL_DETAIL: blocked reason/detail matched: reason=unsupported_operation detail=prewait_impure:sim.proc.print count=1
//
// PASS: deopt_process_rows_non_allowlisted=0
// PASS: unique_reasons_non_allowlisted=0
// PASS: unique_reason_details_non_allowlisted=0
