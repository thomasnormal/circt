// RUN: rm -rf %t
// RUN: mkdir -p %t/bin %t/src
// RUN: cp %S/../../utils/run_opentitan_connectivity_circt_lec.py %t/run_opentitan_connectivity_circt_lec.py
// RUN: printf 'target_name\tflow\tsub_flow\tfusesoc_core\trel_path\tbbox_cmd\tconn_csv_count\tconn_csvs\tcfg_file\nchip_earlgrey_asic\tformal\tconn\tlowrisc:systems:chip_earlgrey_asic:0.1\thw/top_earlgrey/formal\t\t1\t[]\t%t/chip_conn_cfg.hjson\n' > %t/target.tsv
// RUN: printf 'rule_id\trule_type\tcsv_file\tcsv_row\trule_name\tsrc_block\tsrc_signal\tdest_block\tdest_signal\nchip.csv:RULE_A\tCONNECTION\t%t/chip.csv\t10\tRULE_A\ttop_earlgrey.u_src\tclk_o\ttop_earlgrey.u_dst\tclk_i\nchip.csv:RULE_B\tCONNECTION\t%t/chip.csv\t11\tRULE_B\ttop_earlgrey.u_src\tclk_o\ttop_earlgrey.u_dst\tclk_i\n' > %t/rules.tsv
// RUN: printf 'module top_earlgrey;\n  u_src_t u_src();\n  u_dst_t u_dst();\nendmodule\nmodule u_src_t; logic clk_o; endmodule\nmodule u_dst_t; logic clk_i; endmodule\n' > %t/src/top.sv
// RUN: printf '#!/usr/bin/env python3\nimport pathlib, sys\ntarget = sys.argv[sys.argv.index("--target") + 1]\ntool = sys.argv[sys.argv.index("--tool") + 1]\nout_dir = pathlib.Path.cwd() / "build" / "fake" / f"{target}-{tool}"\nout_dir.mkdir(parents=True, exist_ok=True)\n(out_dir / "fake.eda.yml").write_text("""toplevel: top_earlgrey\\nfiles:\\n- name: %t/src/top.sv\\n  file_type: systemVerilogSource\\n""", encoding="utf-8")\n' > %t/bin/fusesoc
// RUN: printf '#!/usr/bin/env python3\nimport pathlib, sys\nargs = sys.argv[1:]\nout = pathlib.Path(args[args.index("-o") + 1])\nout.write_text("module {}\\n", encoding="utf-8")\n' > %t/bin/circt-verilog
// RUN: printf '#!/usr/bin/env python3\nimport pathlib, sys\nargs = sys.argv[1:]\nout = pathlib.Path(args[args.index("-o") + 1])\nout.write_text(pathlib.Path(args[0]).read_text(encoding="utf-8"), encoding="utf-8")\n' > %t/bin/circt-opt
// RUN: printf '#!/usr/bin/env python3\nimport pathlib, sys, time\nargs = sys.argv[1:]\nstate = pathlib.Path("%t/lec.calls")\ncount = int(state.read_text(encoding="utf-8")) if state.exists() else 0\ncount += 1\nstate.write_text(str(count), encoding="utf-8")\nno_flatten = "--flatten-hw=false" in args\nif count == 1:\n  if no_flatten:\n    print("unexpected no-flatten on call 1", file=sys.stderr)\n    raise SystemExit(1)\n  print("timeout-flatten-call-1", flush=True)\n  time.sleep(2)\n  raise SystemExit(0)\nif count == 2:\n  if not no_flatten:\n    print("expected no-flatten on call 2", file=sys.stderr)\n    raise SystemExit(1)\n  print("pass-no-flatten-call-2", flush=True)\n  print("LEC_RESULT=EQ", flush=True)\n  print("LEC_DIAG=EQ", flush=True)\n  raise SystemExit(0)\nif count == 3:\n  if not no_flatten:\n    print("expected no-flatten on call 3", file=sys.stderr)\n    raise SystemExit(1)\n  print("solver must not contain any non-SMT operations", file=sys.stderr)\n  raise SystemExit(1)\nif count == 4:\n  if no_flatten:\n    print("expected flattened retry on call 4", file=sys.stderr)\n    raise SystemExit(1)\n  print("pass-flatten-call-4", flush=True)\n  print("LEC_RESULT=EQ", flush=True)\n  print("LEC_DIAG=EQ", flush=True)\n  raise SystemExit(0)\nprint(f"unexpected call {count}", file=sys.stderr)\nraise SystemExit(1)\n' > %t/bin/circt-lec
// RUN: chmod +x %t/run_opentitan_connectivity_circt_lec.py %t/bin/fusesoc %t/bin/circt-verilog %t/bin/circt-opt %t/bin/circt-lec
// RUN: env LEC_RUN_SMTLIB=1 Z3_BIN=/bin/true CIRCT_TIMEOUT_SECS=1 LEC_CANONICALIZER_TIMEOUT_RETRY_MODE=off LEC_NO_FLATTEN_TIMEOUT_RETRY_MODE=auto CIRCT_VERILOG=%t/bin/circt-verilog CIRCT_OPT=%t/bin/circt-opt CIRCT_LEC=%t/bin/circt-lec python3 %t/run_opentitan_connectivity_circt_lec.py --target-manifest %t/target.tsv --rules-manifest %t/rules.tsv --opentitan-root %t --workdir %t/work --fusesoc-bin %t/bin/fusesoc --results-file %t/results.tsv
// RUN: test "$(cat %t/lec.calls)" = "4"
// RUN: test -f %t/work/cases/connectivity_chip_csv_RULE_A/circt-lec.no-flatten-timeout.log
// RUN: test -f %t/work/cases/connectivity_chip_csv_RULE_B/circt-lec.no-flatten-failure.log
// RUN: rg -n 'solver must not contain any non-SMT operations' %t/work/cases/connectivity_chip_csv_RULE_B/circt-lec.no-flatten-failure.log
// RUN: rg -n 'pass-flatten-call-4' %t/work/cases/connectivity_chip_csv_RULE_B/circt-lec.log
// RUN: not rg -n 'solver must not contain any non-SMT operations' %t/work/cases/connectivity_chip_csv_RULE_B/circt-lec.log
// RUN: FileCheck %s < %t/results.tsv
//
// CHECK-DAG: PASS{{[[:space:]]+}}connectivity::chip.csv:RULE_A{{[[:space:]]+}}{{.*}}opentitan{{[[:space:]]+}}CONNECTIVITY_LEC{{[[:space:]]+}}EQ
// CHECK-DAG: PASS{{[[:space:]]+}}connectivity::chip.csv:RULE_B{{[[:space:]]+}}{{.*}}opentitan{{[[:space:]]+}}CONNECTIVITY_LEC{{[[:space:]]+}}EQ
