// RUN: rm -rf %t
// RUN: mkdir -p %t/bin %t/src
// RUN: cp %S/../../utils/run_opentitan_connectivity_circt_bmc.py %t/run_opentitan_connectivity_circt_bmc.py
// RUN: printf 'target_name\tflow\tsub_flow\tfusesoc_core\trel_path\tbbox_cmd\tconn_csv_count\tconn_csvs\tcfg_file\nchip_earlgrey_asic\tformal\tconn\tlowrisc:systems:chip_earlgrey_asic:0.1\thw/top_earlgrey/formal\t\t1\t[]\t%t/chip_conn_cfg.hjson\n' > %t/target.tsv
// RUN: printf 'rule_id\trule_type\tcsv_file\tcsv_row\trule_name\tsrc_block\tsrc_signal\tdest_block\tdest_signal\nchip.csv:RULE_PAD\tCONNECTION\t%t/chip.csv\t10\tRULE_PAD\ttop_earlgrey.u_src\tpad_o\ttop_earlgrey.u_dst\tpad_i\nchip.csv:CONDITION_1\tCONDITION\t%t/chip.csv\t11\tCONDITION_1\t\tcond_en\t1\x27b1\t\nchip.csv:CONDITION_2\tCONDITION\t%t/chip.csv\t12\tCONDITION_2\ttop_earlgrey.u_rst\trst_ni\t1\x27b1\t1\x27b0\n' > %t/rules.tsv
// RUN: printf 'module top_earlgrey;\n  logic cond_en;\n  u_src_t u_src();\n  u_dst_t u_dst();\n  u_rst_t u_rst();\nendmodule\nmodule u_src_t; logic pad_o; endmodule\nmodule u_dst_t; logic pad_i; endmodule\nmodule u_rst_t; logic rst_ni; endmodule\n' > %t/src/top.sv
// RUN: printf '#!/usr/bin/env python3\nimport pathlib, sys\ntarget = sys.argv[sys.argv.index(\"--target\") + 1]\ntool = sys.argv[sys.argv.index(\"--tool\") + 1]\nout_dir = pathlib.Path.cwd() / \"build\" / \"fake\" / f\"{target}-{tool}\"\nout_dir.mkdir(parents=True, exist_ok=True)\n(out_dir / \"fake.eda.yml\").write_text(\"\"\"toplevel: top_earlgrey\\nfiles:\\n- name: %t/src/top.sv\\n  file_type: systemVerilogSource\\n\"\"\")\n' > %t/bin/fusesoc
// RUN: printf '#!/usr/bin/env python3\nimport pathlib, sys\nargs = sys.argv[1:]\ncases_path = pathlib.Path(args[args.index(\"--cases-file\") + 1])\nrows = [line for line in cases_path.read_text().splitlines() if line.strip()]\nif len(rows) != 1:\n  raise SystemExit(f\"expected 1 case, got {len(rows)}\")\nparts = rows[0].split(\"\\t\")\nchecker = pathlib.Path(parts[2].split(\";\")[-1])\ntext = checker.read_text()\nneed = [\"((cond_en) === (1\\x27b1))\", \"((u_rst.rst_ni) === (1\\x27b1))\", \"((u_rst.rst_ni) === (1\\x27b0))\", \"((u_src.pad_o) === (u_dst.pad_i))\"]\nfor token in need:\n  if token not in text:\n    raise SystemExit(f\"missing token: {token}\")\nresults = pathlib.Path(args[args.index(\"--results-file\") + 1])\nresults.write_text(f\"PASS\\t{parts[0]}\\t/tmp/work\\topentitan\\tCONNECTIVITY_BMC\\tUNSAT\\n\")\n' > %t/bin/fake_pairwise.py
// RUN: chmod +x %t/run_opentitan_connectivity_circt_bmc.py %t/bin/fusesoc %t/bin/fake_pairwise.py
// RUN: python3 %t/run_opentitan_connectivity_circt_bmc.py --target-manifest %t/target.tsv --rules-manifest %t/rules.tsv --opentitan-root %t --workdir %t/work --rule-filter 'CONDITION_2' --fusesoc-bin %t/bin/fusesoc --pairwise-runner %t/bin/fake_pairwise.py --results-file %t/results.tsv
// RUN: FileCheck %s < %t/results.tsv
//
// CHECK: PASS{{[[:space:]]+}}connectivity::chip.csv:RULE_PAD{{[[:space:]]+}}{{.*}}CONNECTIVITY_BMC{{[[:space:]]+}}UNSAT
