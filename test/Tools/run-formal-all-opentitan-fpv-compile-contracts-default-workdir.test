// RUN: rm -rf %t
// RUN: mkdir -p %t/utils %t/bin %t/sv-tests %t/verilator %t/yosys %t/ot/hw/top_earlgrey/formal
// RUN: cp %S/../../utils/run_formal_all.sh %t/utils/run_formal_all.sh
// RUN: cp %S/../../utils/select_opentitan_formal_cfgs.py %t/utils/select_opentitan_formal_cfgs.py
// RUN: printf '#!/usr/bin/env python3\nimport csv\nimport pathlib\nimport sys\nmanifest = \"\"\nout_contracts = \"\"\nworkdir = \"\"\nargs = sys.argv[1:]\nwhile args:\n  tok = args.pop(0)\n  if tok == \"--manifest\":\n    manifest = args.pop(0)\n  elif tok == \"--out-contracts\":\n    out_contracts = args.pop(0)\n  elif tok == \"--workdir\":\n    workdir = args.pop(0)\nif not manifest or not out_contracts or not workdir:\n  raise SystemExit(\"missing required args\")\nif workdir != \"%t/out/opentitan-fpv-contracts-work\":\n  raise SystemExit(f\"unexpected_workdir={workdir}\")\npathlib.Path(\"%t/resolver-workdir.txt\").write_text(workdir + \"\\n\", encoding=\"utf-8\")\nworkdir_path = pathlib.Path(workdir)\n(workdir_path / \"src\").mkdir(parents=True, exist_ok=True)\nsource = workdir_path / \"src\" / \"foo.sv\"\nsource.write_text(\"module foo_tb(input logic clk); endmodule\\n\", encoding=\"utf-8\")\nout = pathlib.Path(out_contracts)\nout.parent.mkdir(parents=True, exist_ok=True)\nwith out.open(\"w\", encoding=\"utf-8\", newline=\"\") as handle:\n  handle.write(\"#opentitan_compile_contract_schema_version=1\\n\")\n  writer = csv.writer(handle, delimiter=\"\\t\", lineterminator=\"\\n\")\n  writer.writerow([\"target_name\", \"rel_path\", \"task_profile\", \"task_known\", \"setup_status\", \"stopat_mode\", \"stopat_count\", \"stopats\", \"blackbox_policy\", \"toplevel\", \"files\", \"include_dirs\", \"defines\"])\n  writer.writerow([\"foo_fpv\", \"hw/top_earlgrey/formal/ip/foo\", \"fpv_default\", \"1\", \"ok\", \"none\", \"0\", \"\", \"none\", \"foo_tb\", str(source), \"\", \"\"])\n' > %t/utils/resolve_opentitan_formal_compile_contracts.py
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\ncompile=\"\"\nwhile [[ $# -gt 0 ]]; do\n  case \"$1\" in\n    --compile-contracts) compile=\"$2\"; shift 2 ;;\n    *) shift ;;\n  esac\ndone\n: \"${OUT:?}\"\nif [[ ! -f \"$compile\" ]]; then\n  echo \"missing_compile_contracts=$compile\" >&2\n  exit 20\nfi\nsource_file=\"$(python3 - \"$compile\" <<'\"'\"'PY'\"'\"'\nimport csv, pathlib, sys\npath = pathlib.Path(sys.argv[1])\nlines = path.read_text(encoding=\"utf-8\").splitlines()\nreader = csv.DictReader(lines[1:], delimiter=\"\\t\")\nrow = next(reader)\nprint((row.get(\"files\") or \"\").split(\";\")[0])\nPY\n)\"\nif [[ -z \"$source_file\" || ! -f \"$source_file\" ]]; then\n  echo \"missing_source_file=$source_file\" >&2\n  exit 21\nfi\nprintf \"PASS\\tfoo_fpv::foo_tb\\t%t/out/opentitan-fpv-bmc-work/foo_fpv/foo_tb\\topentitan\\tFPV_BMC\\tUNSAT\\n\" > \"$OUT\"\n' > %t/utils/run_opentitan_fpv_circt_bmc.py
// RUN: printf '#!/usr/bin/env bash\nexit 0\n' > %t/bin/circt-verilog
// RUN: printf '#!/usr/bin/env bash\nexit 0\n' > %t/bin/circt-opt
// RUN: printf '#!/usr/bin/env bash\nexit 0\n' > %t/bin/circt-bmc
// RUN: printf '#!/usr/bin/env bash\nexit 0\n' > %t/bin/circt-lec
// RUN: printf '#!/usr/bin/env bash\nexit 0\n' > %t/bin/fusesoc
// RUN: printf '{\n  "name": "top_earlgrey_fpv_prim_cfgs",\n  "flow": "formal",\n  "sub_flow": "fpv",\n  "use_cfgs": [\n    {\n      "name": "foo_fpv",\n      "dut": "foo_tb",\n      "fusesoc_core": "lowrisc:fpv:foo_fpv",\n      "task": "FpvDefault",\n      "rel_path": "hw/top_earlgrey/formal/ip/foo"\n    }\n  ]\n}\n' > %t/ot/hw/top_earlgrey/formal/top_earlgrey_fpv_prim_cfgs.hjson
// RUN: chmod +x %t/utils/run_formal_all.sh %t/utils/select_opentitan_formal_cfgs.py %t/utils/resolve_opentitan_formal_compile_contracts.py %t/utils/run_opentitan_fpv_circt_bmc.py %t/bin/circt-verilog %t/bin/circt-opt %t/bin/circt-bmc %t/bin/circt-lec %t/bin/fusesoc
// RUN: cd %t && utils/run_formal_all.sh --out-dir %t/out --sv-tests %t/sv-tests --verilator %t/verilator --yosys %t/yosys --with-opentitan-fpv-bmc --opentitan %t/ot --circt-verilog %t/bin/circt-verilog --include-lane-regex '^opentitan/FPV_BMC$' --opentitan-fpv-cfg %t/ot/hw/top_earlgrey/formal/top_earlgrey_fpv_prim_cfgs.hjson --select-cfgs 'foo_fpv' --opentitan-fpv-fusesoc-bin %t/bin/fusesoc
// RUN: FileCheck %s --check-prefix=WORKDIR < %t/resolver-workdir.txt
// RUN: FileCheck %s --check-prefix=SUMMARY < %t/out/summary.tsv
//
// WORKDIR: {{.*}}/out/opentitan-fpv-contracts-work
// SUMMARY: opentitan{{[[:space:]]+}}FPV_BMC{{[[:space:]]+}}1{{[[:space:]]+}}1{{[[:space:]]+}}0
