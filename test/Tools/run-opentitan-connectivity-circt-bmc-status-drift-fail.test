// RUN: rm -rf %t
// RUN: mkdir -p %t/bin %t/src
// RUN: cp %S/../../utils/run_opentitan_connectivity_circt_bmc.py %t/run_opentitan_connectivity_circt_bmc.py
// RUN: printf 'target_name\tflow\tsub_flow\tfusesoc_core\trel_path\tbbox_cmd\tconn_csv_count\tconn_csvs\tcfg_file\nchip_earlgrey_asic\tformal\tconn\tlowrisc:systems:chip_earlgrey_asic:0.1\thw/top_earlgrey/formal\t\t1\t[]\t%t/chip_conn_cfg.hjson\n' > %t/target.tsv
// RUN: printf 'rule_id\trule_type\tcsv_file\tcsv_row\trule_name\tsrc_block\tsrc_signal\tdest_block\tdest_signal\nchip.csv:RULE_CLK\tCONNECTION\t%t/chip.csv\t10\tRULE_CLK\ttop_earlgrey.u_src\tclk_o\ttop_earlgrey.u_dst\tclk_i\n' > %t/rules.tsv
// RUN: printf 'module top_earlgrey;\n  logic clk_o, clk_i;\n  assign clk_i = clk_o;\n  u_src_t u_src();\n  u_dst_t u_dst();\nendmodule\nmodule u_src_t; logic clk_o; endmodule\nmodule u_dst_t; logic clk_i; endmodule\n' > %t/src/top.sv
// RUN: printf '#!/usr/bin/env python3\nimport pathlib,sys\ntarget = sys.argv[sys.argv.index(\"--target\") + 1]\ntool = sys.argv[sys.argv.index(\"--tool\") + 1]\nout_dir = pathlib.Path.cwd() / \"build\" / \"fake\" / f\"{target}-{tool}\"\nout_dir.mkdir(parents=True, exist_ok=True)\n(out_dir / \"fake.eda.yml\").write_text(\"\"\"toplevel: top_earlgrey\\nfiles:\\n- name: %t/src/top.sv\\n  file_type: systemVerilogSource\\n\"\"\")\n' > %t/bin/fusesoc
// RUN: printf '#!/usr/bin/env python3\nimport pathlib,sys\nargs=sys.argv[1:]\ncases=pathlib.Path(args[args.index(\"--cases-file\")+1]).read_text(encoding=\"utf-8\").splitlines()\nout=pathlib.Path(args[args.index(\"--results-file\")+1])\ncover=pathlib.Path(args[args.index(\"--cover-results-file\")+1])\nrows=[line for line in cases if line.strip()]\nif len(rows)!=1:\n  raise SystemExit(31)\ncase_id=rows[0].split(\"\\t\")[0]\nout.write_text(f\"PASS\\t{case_id}\\t/tmp/work\\topentitan\\tCONNECTIVITY_BMC\\tUNSAT\\n\", encoding=\"utf-8\")\ncover.write_text(f\"COVERED\\t{case_id}\\t/tmp/work\\tc0000\\tline_1\\tSAT\\tsat\\n\", encoding=\"utf-8\")\n' > %t/bin/fake_pairwise.py
// RUN: printf 'rule_id\tcase_total\tcase_pass\tcase_fail\tcase_xfail\tcase_xpass\tcase_error\tcase_skip\tcover_total\tcover_covered\tcover_unreachable\tcover_timeout\tcover_unknown\tcover_skip\tcover_error\nchip.csv:RULE_CLK\t1\t0\t0\t0\t0\t1\t0\t1\t0\t1\t0\t0\t0\t0\n' > %t/baseline.tsv
// RUN: chmod +x %t/run_opentitan_connectivity_circt_bmc.py %t/bin/fusesoc %t/bin/fake_pairwise.py
// RUN: not sh -c 'env BMC_COVER_RESULTS_OUT=%t/covers.tsv BMC_CONNECTIVITY_STATUS_SUMMARY_OUT=%t/status.tsv BMC_CONNECTIVITY_STATUS_BASELINE_FILE=%t/baseline.tsv BMC_CONNECTIVITY_STATUS_DRIFT_OUT=%t/drift.tsv BMC_FAIL_ON_CONNECTIVITY_STATUS_DRIFT=1 python3 %t/run_opentitan_connectivity_circt_bmc.py --target-manifest %t/target.tsv --rules-manifest %t/rules.tsv --opentitan-root %t --workdir %t/work --rule-filter "RULE_CLK" --fusesoc-bin %t/bin/fusesoc --pairwise-runner %t/bin/fake_pairwise.py --results-file %t/results.tsv' 2>&1 | FileCheck %s --check-prefix=LOG
// RUN: FileCheck %s --check-prefix=DRIFT < %t/drift.tsv
// RUN: FileCheck %s --check-prefix=RESULTS < %t/results.tsv
//
// LOG: opentitan connectivity status drift detected
// DRIFT: rule_id{{[[:space:]]+}}kind{{[[:space:]]+}}baseline{{[[:space:]]+}}current{{[[:space:]]+}}allowlisted
// DRIFT: chip.csv:RULE_CLK{{[[:space:]]+}}case_pass{{[[:space:]]+}}0{{[[:space:]]+}}1{{[[:space:]]+}}0
// DRIFT: chip.csv:RULE_CLK{{[[:space:]]+}}cover_covered{{[[:space:]]+}}0{{[[:space:]]+}}1{{[[:space:]]+}}0
// RESULTS: PASS{{[[:space:]]+}}connectivity::chip.csv:RULE_CLK{{[[:space:]]+}}{{.*}}
// RESULTS: ERROR{{[[:space:]]+}}connectivity_status_drift{{[[:space:]]+}}{{.*}}BMC_DRIFT_ERROR{{[[:space:]]+}}connectivity_status_drift
