// RUN: rm -rf %t
// RUN: mkdir -p %t/bin %t/src
// RUN: cp %S/../../utils/run_opentitan_connectivity_circt_lec.py %t/run_opentitan_connectivity_circt_lec.py
// RUN: printf 'target_name\tflow\tsub_flow\tfusesoc_core\trel_path\tbbox_cmd\tconn_csv_count\tconn_csvs\tcfg_file\nchip_earlgrey_asic\tformal\tconn\tlowrisc:systems:chip_earlgrey_asic:0.1\thw/top_earlgrey/formal\t\t1\t[]\t%t/chip_conn_cfg.hjson\n' > %t/target.tsv
// RUN: printf 'rule_id\trule_type\tcsv_file\tcsv_row\trule_name\tsrc_block\tsrc_signal\tdest_block\tdest_signal\nchip.csv:RULE_A\tCONNECTION\t%t/chip.csv\t10\tRULE_A\ttop_earlgrey.u_src0\tclk_o\ttop_earlgrey.u_dst0\tclk_i\nchip.csv:RULE_B\tCONNECTION\t%t/chip.csv\t11\tRULE_B\ttop_earlgrey.u_src1\tclk_o\ttop_earlgrey.u_dst1\tclk_i\nchip.csv:RULE_C\tCONNECTION\t%t/chip.csv\t12\tRULE_C\ttop_earlgrey.u_src2\tclk_o\ttop_earlgrey.u_dst2\tclk_i\nchip.csv:RULE_D\tCONNECTION\t%t/chip.csv\t13\tRULE_D\ttop_earlgrey.u_src3\tclk_o\ttop_earlgrey.u_dst3\tclk_i\n' > %t/rules.tsv
// RUN: printf 'module top_earlgrey;\n  u_src_t u_src0();\n  u_dst_t u_dst0();\n  u_src_t u_src1();\n  u_dst_t u_dst1();\n  u_src_t u_src2();\n  u_dst_t u_dst2();\n  u_src_t u_src3();\n  u_dst_t u_dst3();\nendmodule\nmodule u_src_t; logic clk_o; endmodule\nmodule u_dst_t; logic clk_i; endmodule\n' > %t/src/top.sv
// RUN: printf '#!/usr/bin/env python3\nimport pathlib\nout_dir = pathlib.Path.cwd() / \"build\" / \"fake\" / \"formal-lec\"\nout_dir.mkdir(parents=True, exist_ok=True)\n(out_dir / \"fake.eda.yml\").write_text(\"\"\"toplevel: top_earlgrey\\nfiles:\\n- name: %t/src/top.sv\\n  file_type: systemVerilogSource\\n\"\"\", encoding=\"utf-8\")\n' > %t/bin/fusesoc
// RUN: printf '#!/usr/bin/env python3\nimport pathlib, sys\nargs = sys.argv[1:]\nout = pathlib.Path(args[args.index(\"-o\") + 1])\nout.write_text(\"module {}\\n\", encoding=\"utf-8\")\n' > %t/bin/circt-verilog
// RUN: printf '#!/usr/bin/env python3\nimport pathlib, sys\nargs = sys.argv[1:]\nout = pathlib.Path(args[args.index(\"-o\") + 1])\nout.write_text(pathlib.Path(args[0]).read_text(encoding=\"utf-8\"), encoding=\"utf-8\")\n' > %t/bin/circt-opt
// RUN: printf '#!/usr/bin/env python3\nimport pathlib, sys, time\nargs = sys.argv[1:]\nlog = pathlib.Path(\"%t/lec_invocations.log\")\nlog.parent.mkdir(parents=True, exist_ok=True)\nwith log.open(\"a\", encoding=\"utf-8\") as handle:\n  handle.write(\" \".join(args) + \"\\n\")\nc1 = next((arg.split(\"=\", 1)[1] for arg in args if arg.startswith(\"-c1=\")), \"\")\nif \"batch_precheck\" in c1:\n  state = pathlib.Path(\"%t/precheck_calls.txt\")\n  count = int(state.read_text(encoding=\"utf-8\")) if state.exists() else 0\n  count += 1\n  state.write_text(str(count), encoding=\"utf-8\")\n  if count == 1:\n    time.sleep(2.0)\n  print(\"LEC_RESULT=EQ\")\n  print(\"LEC_DIAG=EQ_BATCH\")\n  raise SystemExit(0)\nprint(\"LEC_RESULT=EQ\")\nprint(\"LEC_DIAG=EQ_CASE\")\n' > %t/bin/circt-lec
// RUN: chmod +x %t/run_opentitan_connectivity_circt_lec.py %t/bin/fusesoc %t/bin/circt-verilog %t/bin/circt-opt %t/bin/circt-lec
// RUN: LEC_RUN_SMTLIB=0 LEC_BATCH_PRECHECK_MODE=on LEC_BATCH_PRECHECK_MIN_CASES=2 LEC_BATCH_PRECHECK_TIMEOUT_SPLIT_MODE=on CIRCT_TIMEOUT_SECS=1 CIRCT_VERILOG=%t/bin/circt-verilog CIRCT_OPT=%t/bin/circt-opt CIRCT_LEC=%t/bin/circt-lec python3 %t/run_opentitan_connectivity_circt_lec.py --target-manifest %t/target.tsv --rules-manifest %t/rules.tsv --opentitan-root %t --workdir %t/work --fusesoc-bin %t/bin/fusesoc --results-file %t/results.tsv
// RUN: grep -c "__circt_connectivity_batch_precheck_" %t/lec_invocations.log > %t/precheck_count.txt
// RUN: test "$(cat %t/precheck_count.txt)" -ge "3"
// RUN: FileCheck %s --check-prefix=RESULTS < %t/results.tsv
// RUN: FileCheck %s --check-prefix=INVOKE < %t/lec_invocations.log
//
// RESULTS-DAG: PASS{{[[:space:]]+}}connectivity::chip.csv:RULE_A{{[[:space:]]+}}{{.*}}EQ_BATCH
// RESULTS-DAG: PASS{{[[:space:]]+}}connectivity::chip.csv:RULE_B{{[[:space:]]+}}{{.*}}EQ_BATCH
// RESULTS-DAG: PASS{{[[:space:]]+}}connectivity::chip.csv:RULE_C{{[[:space:]]+}}{{.*}}EQ_BATCH
// RESULTS-DAG: PASS{{[[:space:]]+}}connectivity::chip.csv:RULE_D{{[[:space:]]+}}{{.*}}EQ_BATCH
//
// INVOKE: -c1=__circt_connectivity_batch_precheck_
// INVOKE-NOT: __circt_conn_rule_
