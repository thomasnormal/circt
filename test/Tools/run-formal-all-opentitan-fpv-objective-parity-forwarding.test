// RUN: rm -rf %t
// RUN: mkdir -p %t/utils %t/bin %t/sv-tests %t/verilator %t/yosys %t/ot/hw/top_earlgrey/formal
// RUN: cp %S/../../utils/run_formal_all.sh %t/utils/run_formal_all.sh
// RUN: cp %S/../../utils/select_opentitan_formal_cfgs.py %t/utils/select_opentitan_formal_cfgs.py
// RUN: cp %S/../../utils/resolve_opentitan_formal_compile_contracts.py %t/utils/resolve_opentitan_formal_compile_contracts.py
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\ncompile=\"\"\nwhile [[ $# -gt 0 ]]; do\n  case \"$1\" in\n    --compile-contracts) compile=\"$2\"; shift 2 ;;\n    *) shift ;;\n  esac\ndone\n: \"${OUT:?}\"\n: \"${BMC_ASSERTION_RESULTS_OUT:?}\"\n: \"${BMC_COVER_RESULTS_OUT:?}\"\n: \"${BMC_FPV_SUMMARY_OUT:?}\"\nif [[ ! -f \"$compile\" ]]; then\n  echo \"missing_compile_contracts=$compile\" >&2\n  exit 10\nfi\nprintf \"PASS\\tfoo_fpv::foo_tb\\t%t/out/opentitan-fpv-bmc-work/foo_fpv/foo_tb\\topentitan\\tFPV_BMC\\tUNSAT\\n\" > \"$OUT\"\nprintf \"PROVEN\\tfoo_fpv::foo_tb\\t%t/out/opentitan-fpv-bmc-work/foo_fpv/foo_tb\\ta0000\\tline_10\\tUNSAT\\tunsat\\n\" > \"$BMC_ASSERTION_RESULTS_OUT\"\nprintf \"COVERED\\tfoo_fpv::foo_tb\\t%t/out/opentitan-fpv-bmc-work/foo_fpv/foo_tb\\tc0000\\tline_20\\tSAT\\tsat\\n\" > \"$BMC_COVER_RESULTS_OUT\"\nprintf \"target_name\\ttotal_assertions\\tproven\\tfailing\\tvacuous\\tcovered\\tunreachable\\tunknown\\terror\\ttimeout\\tskipped\\nfoo_fpv\\t2\\t1\\t0\\t0\\t1\\t0\\t0\\t0\\t0\\t0\\n\" > \"$BMC_FPV_SUMMARY_OUT\"\n' > %t/utils/run_opentitan_fpv_circt_bmc.py
// RUN: printf '#!/usr/bin/env python3\nimport argparse\nimport pathlib\nimport sys\n\np = argparse.ArgumentParser()\np.add_argument(\"--bmc-assertion-results\", required=True)\np.add_argument(\"--lec-assertion-results\", required=True)\np.add_argument(\"--bmc-cover-results\", default=\"\")\np.add_argument(\"--lec-cover-results\", default=\"\")\np.add_argument(\"--allowlist-file\", default=\"\")\np.add_argument(\"--out-parity-tsv\", default=\"\")\np.add_argument(\"--fail-on-mismatch\", action=\"store_true\")\np.add_argument(\"--include-missing-objectives\", action=\"store_true\")\np.add_argument(\"--missing-objective-policy\", default=\"ignore\")\na = p.parse_args()\nif a.allowlist_file != \"%t/fpv-objective-allowlist.txt\":\n  print(f\"bad_allowlist={a.allowlist_file}\", file=sys.stderr)\n  raise SystemExit(11)\nif a.lec_assertion_results != \"%t/fpv-lec-assertions.tsv\":\n  print(f\"bad_lec_assertions={a.lec_assertion_results}\", file=sys.stderr)\n  raise SystemExit(12)\nif a.lec_cover_results != \"%t/fpv-lec-cover.tsv\":\n  print(f\"bad_lec_cover={a.lec_cover_results}\", file=sys.stderr)\n  raise SystemExit(13)\nif not a.fail_on_mismatch:\n  print(\"missing_fail_on_mismatch\", file=sys.stderr)\n  raise SystemExit(14)\nif not a.include_missing_objectives:\n  print(\"missing_include_missing\", file=sys.stderr)\n  raise SystemExit(15)\nif a.missing_objective_policy != \"assertion\":\n  print(f\"bad_missing_policy={a.missing_objective_policy}\", file=sys.stderr)\n  raise SystemExit(16)\nfor field in (a.bmc_assertion_results, a.lec_assertion_results, a.bmc_cover_results, a.lec_cover_results):\n  if field and not pathlib.Path(field).is_file():\n    print(f\"missing_input={field}\", file=sys.stderr)\n    raise SystemExit(17)\nout_path = pathlib.Path(a.out_parity_tsv)\nout_path.parent.mkdir(parents=True, exist_ok=True)\nout_path.write_text(\"objective_id\\tobjective_class\\ttarget_name\\tcase_id\\tobjective_key\\tkind\\tbmc\\tlec\\tbmc_case_path\\tlec_case_path\\tbmc_evidence\\tlec_evidence\\tbmc_reason\\tlec_reason\\tallowlisted\\ncover::foo_fpv::foo_tb::c0000\\tcover\\tfoo_fpv\\tfoo_fpv::foo_tb\\tfoo_fpv::foo_tb::c0000\\tmissing_in_lec\\tpresent\\tabsent\\t%t/out/opentitan-fpv-bmc-work/foo_fpv/foo_tb\\t\\tSAT\\t\\tprojected_case_eq\\t\\t1\\n\", encoding=\"utf-8\")\nprint(\"fake fpv objective parity checker ok\", file=sys.stderr)\n' > %t/utils/check_opentitan_fpv_objective_parity.py
// RUN: printf '#!/usr/bin/env bash\nexit 0\n' > %t/bin/circt-verilog
// RUN: printf '#!/usr/bin/env bash\nexit 0\n' > %t/bin/circt-opt
// RUN: printf '#!/usr/bin/env bash\nexit 0\n' > %t/bin/circt-bmc
// RUN: printf '#!/usr/bin/env bash\nexit 0\n' > %t/bin/circt-lec
// RUN: printf '#!/usr/bin/env python3\nimport pathlib,sys\ncore = sys.argv[-1]\ntool = sys.argv[sys.argv.index(\"--tool\") + 1]\ntarget = sys.argv[sys.argv.index(\"--target\") + 1]\ncore_token = core.replace(\":\", \"_\").replace(\".\", \"_\")\nout_dir = pathlib.Path.cwd() / \"build\" / core_token / f\"{target}-{tool}\"\nout_dir.mkdir(parents=True, exist_ok=True)\neda = out_dir / f\"{core_token}.eda.yml\"\neda.write_text(\"\"\"toplevel: foo_tb\\nfiles:\\n- core: lowrisc:foo:pkg:0\\n  file_type: systemVerilogSource\\n  name: ../src/foo.sv\\n\"\"\")\n' > %t/bin/fusesoc
// RUN: printf '{\n  "name": "top_earlgrey_fpv_prim_cfgs",\n  "flow": "formal",\n  "sub_flow": "fpv",\n  "use_cfgs": [\n    {\n      "name": "foo_fpv",\n      "dut": "foo_tb",\n      "fusesoc_core": "lowrisc:fpv:foo_fpv",\n      "task": "FpvDefault",\n      "rel_path": "hw/top_earlgrey/formal/ip/foo"\n    }\n  ]\n}\n' > %t/ot/hw/top_earlgrey/formal/top_earlgrey_fpv_prim_cfgs.hjson
// RUN: printf 'PROVEN\tfoo_fpv::foo_tb\t%t/lec/foo_tb\ta0000\tline_10\tEQ\teq\n' > %t/fpv-lec-assertions.tsv
// RUN: printf '' > %t/fpv-lec-cover.tsv
// RUN: printf 'exact:cover::foo_fpv::foo_tb::c0000::missing_in_lec\n' > %t/fpv-objective-allowlist.txt
// RUN: chmod +x %t/utils/run_formal_all.sh %t/utils/select_opentitan_formal_cfgs.py %t/utils/resolve_opentitan_formal_compile_contracts.py %t/utils/run_opentitan_fpv_circt_bmc.py %t/utils/check_opentitan_fpv_objective_parity.py %t/bin/circt-verilog %t/bin/circt-opt %t/bin/circt-bmc %t/bin/circt-lec %t/bin/fusesoc
// RUN: cd %t && utils/run_formal_all.sh --out-dir %t/out --sv-tests %t/sv-tests --verilator %t/verilator --yosys %t/yosys --with-opentitan-fpv-bmc --opentitan %t/ot --circt-verilog %t/bin/circt-verilog --include-lane-regex '^opentitan/(FPV_BMC|FPV_OBJECTIVE_PARITY)$' --opentitan-fpv-cfg %t/ot/hw/top_earlgrey/formal/top_earlgrey_fpv_prim_cfgs.hjson --select-cfgs 'foo_fpv' --opentitan-fpv-fusesoc-bin %t/bin/fusesoc --opentitan-fpv-lec-assertion-results-file %t/fpv-lec-assertions.tsv --opentitan-fpv-lec-cover-results-file %t/fpv-lec-cover.tsv --opentitan-fpv-objective-parity-file %t/out/opentitan-fpv-objective-parity.tsv --opentitan-fpv-objective-parity-allowlist-file %t/fpv-objective-allowlist.txt --fail-on-opentitan-fpv-objective-parity --opentitan-fpv-objective-parity-include-missing --opentitan-fpv-objective-parity-missing-policy assertion
// RUN: FileCheck %s --check-prefix=SUM < %t/out/summary.tsv
// RUN: FileCheck %s --check-prefix=PARITY < %t/out/opentitan-fpv-objective-parity.tsv
//
// SUM: opentitan{{[[:space:]]+}}FPV_BMC{{[[:space:]]+}}1{{[[:space:]]+}}1{{[[:space:]]+}}0
// SUM: opentitan{{[[:space:]]+}}FPV_OBJECTIVE_PARITY{{[[:space:]]+}}1{{[[:space:]]+}}1{{[[:space:]]+}}0{{.*}}fpv_objective_parity_rows=1{{.*}}fpv_objective_parity_non_allowlisted_rows=0{{.*}}fpv_objective_parity_allowlisted_rows=1{{.*}}fpv_objective_parity_assertion_rows=0{{.*}}fpv_objective_parity_cover_rows=1{{.*}}fpv_objective_parity_missing_rows=1{{.*}}fpv_objective_parity_assertion_status_rows=0{{.*}}fpv_objective_parity_cover_status_rows=0{{.*}}fpv_objective_parity_assertion_non_allowlisted_rows=0{{.*}}fpv_objective_parity_cover_non_allowlisted_rows=0{{.*}}fpv_objective_parity_projected_rows=1{{.*}}fpv_objective_parity_projected_non_allowlisted_rows=0{{.*}}fpv_objective_parity_projected_assertion_rows=0{{.*}}fpv_objective_parity_projected_cover_rows=1
// PARITY: objective_id{{[[:space:]]+}}objective_class{{[[:space:]]+}}target_name{{[[:space:]]+}}case_id{{[[:space:]]+}}objective_key{{[[:space:]]+}}kind{{[[:space:]]+}}bmc{{[[:space:]]+}}lec{{[[:space:]]+}}bmc_case_path{{[[:space:]]+}}lec_case_path{{[[:space:]]+}}bmc_evidence{{[[:space:]]+}}lec_evidence{{[[:space:]]+}}bmc_reason{{[[:space:]]+}}lec_reason{{[[:space:]]+}}allowlisted
// PARITY: cover::foo_fpv::foo_tb::c0000{{[[:space:]]+}}cover{{[[:space:]]+}}foo_fpv{{[[:space:]]+}}foo_fpv::foo_tb{{[[:space:]]+}}foo_fpv::foo_tb::c0000{{[[:space:]]+}}missing_in_lec{{[[:space:]]+}}present{{[[:space:]]+}}absent{{[[:space:]]+}}{{.*}}opentitan-fpv-bmc-work/foo_fpv/foo_tb{{[[:space:]]+}}{{.*}}projected_case_eq{{[[:space:]]+}}1
