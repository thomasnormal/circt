// RUN: rm -rf %t
// RUN: mkdir -p %t/mbit/apb_avip/sim
// RUN: : > %t/mbit/apb_avip/sim/apb_compile.f
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\n: > "${OUT:?OUT is required}"\n' > %t/fake-run-avip.sh
// RUN: chmod +x %t/fake-run-avip.sh
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\necho "Simulation terminated at time 10 fs"\necho "UVM_FATAL : 0"\necho "UVM_ERROR : 0"\necho "Coverage = 100 %%%%"\necho "Coverage = 100 %%%%"\n' > %t/fake-circt-sim
// RUN: chmod +x %t/fake-circt-sim
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\nexit 0\n' > %t/fake-circt-verilog
// RUN: chmod +x %t/fake-circt-verilog

// RUN: env MBIT_DIR=%t/mbit AVIPS=apb SEEDS=1 CIRCT_VERILOG=%t/fake-circt-verilog CIRCT_SIM=%t/fake-circt-sim CIRCT_ALLOW_NONCANONICAL_TOOLS=1 RUN_AVIP=%t/fake-run-avip.sh COMPILE_TIMEOUT=10 SIM_TIMEOUT=10 MAX_WALL_MS=1000 %S/../../utils/run_avip_circt_sim.sh %t/out > %t/log.txt 2>&1
// RUN: FileCheck %s --check-prefix=LOG < %t/log.txt
// RUN: FileCheck %s --check-prefix=MATRIX < %t/out/matrix.tsv
// RUN: FileCheck %s --check-prefix=META < %t/out/meta.txt

// RUN: not %S/../../utils/run_sv_tests_circt_sim.sh %t/missing-sv-tests 2>&1 | FileCheck %s --check-prefix=SVERR

// LOG: [avip-circt-sim] apb seed=1 sim_status=OK sim_exit=0

// MATRIX: {{^avip[[:space:]]+seed[[:space:]]+compile_status[[:space:]]+compile_sec[[:space:]]+sim_status[[:space:]]+sim_exit[[:space:]]+sim_sec[[:space:]]+sim_time_fs[[:space:]]+uvm_fatal[[:space:]]+uvm_error[[:space:]]+cov_1_pct[[:space:]]+cov_2_pct[[:space:]]+peak_rss_kb[[:space:]]+compile_log[[:space:]]+sim_log$}}
// MATRIX: {{^apb[[:space:]]+1[[:space:]]+OK[[:space:]]+[0-9]+[[:space:]]+OK[[:space:]]+0[[:space:]]+[0-9]+[[:space:]]+10[[:space:]]+0[[:space:]]+0[[:space:]]+100[[:space:]]+100[[:space:]]+-[[:space:]]+.*compile\.log[[:space:]]+.*sim_seed_1\.log$}}

// META: script_path={{.*}}/utils/run_avip_circt_sim.sh
// META: avips=apb
// META: seeds=1
// META: sim_timeout_hard=40
// META: circt_sim_mode=interpret
// META: circt_sim_extra_args=<none>
// META: fail_on_functional_gate=0
// META: fail_on_coverage_baseline=0

// SVERR: sv-tests directory not found: {{.*}}/missing-sv-tests
