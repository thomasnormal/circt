// RUN: rm -rf %t
// RUN: mkdir -p %t/utils
// RUN: cp %S/../../utils/run_formal_cadence.sh %t/utils/run_formal_cadence.sh
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\nOUT_DIR=\"\"\nwhile [[ $# -gt 0 ]]; do\n  if [[ \"$1\" == \"--out-dir\" ]]; then OUT_DIR=\"$2\"; shift 2; continue; fi\n  shift\ndone\nmkdir -p \"$OUT_DIR\"\nprintf \"ok\\n\" > \"$OUT_DIR/ok.txt\"\n' > %t/utils/fake-formal-all.sh
// RUN: chmod +x %t/utils/run_formal_cadence.sh %t/utils/fake-formal-all.sh
// RUN: cd %t && utils/run_formal_cadence.sh --interval-secs 0 --iterations 2 --run-formal-all %t/utils/fake-formal-all.sh --strict-gate
// RUN: test -d %t/formal-cadence-results-*/run-0001-*
// RUN: test -d %t/formal-cadence-results-*/run-0002-*
// RUN: cat %t/formal-cadence-results-*/cadence.log | FileCheck %s --check-prefix=PASSLOG
// RUN: cd %t && utils/run_formal_cadence.sh --out-root %t/formal-cadence-retain --interval-secs 0 --iterations 3 --retain-runs 1 --run-formal-all %t/utils/fake-formal-all.sh --strict-gate
// RUN: sh -c 'count=$(find %t/formal-cadence-retain -mindepth 1 -maxdepth 1 -type d -name "run-*" | wc -l); test "$count" -eq 1'
// RUN: cat %t/formal-cadence-retain/cadence.log | FileCheck %s --check-prefix=RETAINLOG
// RUN: mkdir -p %t/formal-cadence-age/run-0000-20000101-000000
// RUN: touch -t 200001010000 %t/formal-cadence-age/run-0000-20000101-000000
// RUN: cd %t && utils/run_formal_cadence.sh --out-root %t/formal-cadence-age --interval-secs 0 --iterations 1 --retain-hours 1 --run-formal-all %t/utils/fake-formal-all.sh --strict-gate
// RUN: test ! -d %t/formal-cadence-age/run-0000-20000101-000000
// RUN: cat %t/formal-cadence-age/cadence.log | FileCheck %s --check-prefix=AGELOG
//
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\nSTATE_FILE=\"%t/fail-counter.txt\"\ncount=0\nif [[ -f \"$STATE_FILE\" ]]; then count=$(cat \"$STATE_FILE\"); fi\ncount=$((count + 1))\necho \"$count\" > \"$STATE_FILE\"\nif [[ \"$count\" -ge 2 ]]; then\n  echo \"forced failure\"\n  exit 3\nfi\nexit 0\n' > %t/utils/fake-formal-all-fail.sh
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\necho \"hook_invoked=1\" > %t/hook-call.txt\n' > %t/utils/fail-hook.sh
// RUN: chmod +x %t/utils/fake-formal-all-fail.sh
// RUN: chmod +x %t/utils/fail-hook.sh
// RUN: not sh -c 'cd %t && utils/run_formal_cadence.sh --interval-secs 0 --iterations 3 --run-formal-all %t/utils/fake-formal-all-fail.sh --on-fail-hook %t/utils/fail-hook.sh --no-strict-gate' 2>&1 | FileCheck %s --check-prefix=FAILFAST
// RUN: cat %t/hook-call.txt | FileCheck %s --check-prefix=HOOK
//
// PASSLOG: completed_iterations=2
// RETAINLOG: pruned_run_dir=
// AGELOG: pruned_run_dir={{.*run-0000-20000101-000000}}
// FAILFAST: failing fast: iteration 2 failed
// HOOK: hook_invoked=1
