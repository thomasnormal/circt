// RUN: rm -rf %t
// RUN: mkdir -p %t/utils
// RUN: cp %S/../../utils/run_formal_cadence.sh %t/utils/run_formal_cadence.sh
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\nOUT_DIR=\"\"\nwhile [[ $# -gt 0 ]]; do\n  if [[ \"$1\" == \"--out-dir\" ]]; then OUT_DIR=\"$2\"; shift 2; continue; fi\n  shift\ndone\nmkdir -p \"$OUT_DIR\"\nprintf \"ok\\n\" > \"$OUT_DIR/ok.txt\"\n' > %t/utils/fake-formal-all.sh
// RUN: chmod +x %t/utils/run_formal_cadence.sh %t/utils/fake-formal-all.sh
// RUN: cd %t && utils/run_formal_cadence.sh --interval-secs 0 --iterations 2 --run-formal-all %t/utils/fake-formal-all.sh --strict-gate
// RUN: test -d %t/formal-cadence-results-*/run-0001-*
// RUN: test -d %t/formal-cadence-results-*/run-0002-*
// RUN: cat %t/formal-cadence-results-*/cadence.log | FileCheck %s --check-prefix=PASSLOG
// RUN: cd %t && utils/run_formal_cadence.sh --out-root %t/formal-cadence-retain --interval-secs 0 --iterations 3 --retain-runs 1 --run-formal-all %t/utils/fake-formal-all.sh --strict-gate
// RUN: sh -c 'count=$(find %t/formal-cadence-retain -mindepth 1 -maxdepth 1 -type d -name "run-*" | wc -l); test "$count" -eq 1'
// RUN: cat %t/formal-cadence-retain/cadence.log | FileCheck %s --check-prefix=RETAINLOG
// RUN: mkdir -p %t/formal-cadence-age/run-0000-20000101-000000
// RUN: touch -t 200001010000 %t/formal-cadence-age/run-0000-20000101-000000
// RUN: cd %t && utils/run_formal_cadence.sh --out-root %t/formal-cadence-age --interval-secs 0 --iterations 1 --retain-hours 1 --run-formal-all %t/utils/fake-formal-all.sh --strict-gate
// RUN: test ! -d %t/formal-cadence-age/run-0000-20000101-000000
// RUN: cat %t/formal-cadence-age/cadence.log | FileCheck %s --check-prefix=AGELOG
//
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\nSTATE_FILE=\"%t/fail-counter.txt\"\ncount=0\nif [[ -f \"$STATE_FILE\" ]]; then count=$(cat \"$STATE_FILE\"); fi\ncount=$((count + 1))\necho \"$count\" > \"$STATE_FILE\"\nif [[ \"$count\" -ge 2 ]]; then\n  echo \"forced failure\"\n  exit 3\nfi\nexit 0\n' > %t/utils/fake-formal-all-fail.sh
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\necho \"hook_invoked=1\" > %t/hook-call.txt\n' > %t/utils/fail-hook.sh
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\nSTATE=%t/curl-state.txt\ncount=0\nif [[ -f \"$STATE\" ]]; then count=$(cat \"$STATE\"); fi\ncount=$((count + 1))\necho \"$count\" > \"$STATE\"\nprintf \"call=%%%%s\\n\" \"$count\" >> %t/curl-call.txt\nprintf \"%%%%s\\n\" \"$@\" >> %t/curl-call.txt\nif [[ \"$count\" -eq 1 ]]; then\n  exit 7\nfi\n' > %t/utils/curl
// RUN: chmod +x %t/utils/fake-formal-all-fail.sh
// RUN: chmod +x %t/utils/fail-hook.sh
// RUN: chmod +x %t/utils/curl
// RUN: not sh -c 'cd %t && PATH=%t/utils:$PATH utils/run_formal_cadence.sh --interval-secs 0 --iterations 3 --run-formal-all %t/utils/fake-formal-all-fail.sh --on-fail-hook %t/utils/fail-hook.sh --on-fail-webhook https://example.invalid/formal-a --on-fail-webhook https://example.invalid/formal-b --webhook-retries 1 --webhook-backoff-secs 0 --no-strict-gate' 2>&1 | FileCheck %s --check-prefix=FAILFAST
// RUN: cat %t/hook-call.txt | FileCheck %s --check-prefix=HOOK
// RUN: cat %t/curl-call.txt | FileCheck %s --check-prefix=WEBHOOK
// RUN: sh -c 'count=$(grep -c "^call=" %t/curl-call.txt); test "$count" -eq 3'
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\nexit 3\n' > %t/utils/fake-formal-all-fail-immediate.sh
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\nSTATE=%t/curl-exp-state.txt\ncount=0\nif [[ -f \"$STATE\" ]]; then count=$(cat \"$STATE\"); fi\ncount=$((count + 1))\necho \"$count\" > \"$STATE\"\nprintf \"exp_call=%%%%s\\n\" \"$count\" >> %t/curl-exp-call.txt\nprintf \"%%%%s\\n\" \"$@\" >> %t/curl-exp-call.txt\nif [[ \"$count\" -le 2 ]]; then\n  exit 7\nfi\n' > %t/utils/curl-exp
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\nprintf \"%%%%s\\n\" \"$1\" >> %t/sleep-exp-call.txt\n' > %t/utils/sleep
// RUN: chmod +x %t/utils/fake-formal-all-fail-immediate.sh %t/utils/curl-exp %t/utils/sleep
// RUN: not sh -c 'cd %t && rm -f %t/curl-exp-call.txt %t/curl-exp-state.txt %t/sleep-exp-call.txt && cp %t/utils/curl-exp %t/utils/curl && PATH=%t/utils:$PATH utils/run_formal_cadence.sh --interval-secs 0 --iterations 1 --run-formal-all %t/utils/fake-formal-all-fail-immediate.sh --on-fail-webhook https://example.invalid/formal-exp --webhook-retries 2 --webhook-backoff-mode exponential --webhook-backoff-secs 2 --webhook-backoff-max-secs 20 --webhook-jitter-secs 0 --no-strict-gate' 2>&1 | FileCheck %s --check-prefix=EXPFAILFAST
// RUN: cat %t/sleep-exp-call.txt | FileCheck %s --check-prefix=EXPSLEEP
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\nprintf \"%%%%s\\n\" \"$@\" >> %t/curl-par-call.txt\nexit 0\n' > %t/utils/curl-par
// RUN: chmod +x %t/utils/curl-par
// RUN: not sh -c 'cd %t && rm -f %t/curl-par-call.txt && cp %t/utils/curl-par %t/utils/curl && PATH=%t/utils:$PATH utils/run_formal_cadence.sh --interval-secs 0 --iterations 1 --run-formal-all %t/utils/fake-formal-all-fail-immediate.sh --on-fail-webhook https://example.invalid/formal-p1 --on-fail-webhook https://example.invalid/formal-p2 --webhook-fanout-mode parallel --webhook-max-parallel 1 --webhook-retries 0 --no-strict-gate' 2>&1 | FileCheck %s --check-prefix=PARFAILFAST
// RUN: cat %t/formal-cadence-results-*/cadence.log | FileCheck %s --check-prefix=PARLOG
// RUN: cat %t/curl-par-call.txt | FileCheck %s --check-prefix=PARWEBHOOK
// RUN: printf '{"webhooks":[{"url":"https://example.invalid/cfg-a","retries":2,"backoff_mode":"fixed","backoff_secs":0,"backoff_max_secs":0,"jitter_secs":0,"timeout_secs":9},{"url":"https://example.invalid/cfg-b","retries":0,"timeout_secs":9}]}\n' > %t/webhook-config.json
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\nurl=\"${@: -1}\"\nprintf \"cfg_url=%%%%s\\n\" \"$url\" >> %t/curl-cfg-call.txt\nif [[ \"$url\" == *\"cfg-a\" ]]; then\n  state=%t/curl-cfg-a-state.txt\n  count=0\n  if [[ -f \"$state\" ]]; then count=$(cat \"$state\"); fi\n  count=$((count + 1))\n  echo \"$count\" > \"$state\"\n  if [[ \"$count\" -le 2 ]]; then\n    exit 7\n  fi\nfi\n' > %t/utils/curl-cfg
// RUN: chmod +x %t/utils/curl-cfg
// RUN: not sh -c 'cd %t && rm -f %t/curl-cfg-call.txt %t/curl-cfg-a-state.txt && cp %t/utils/curl-cfg %t/utils/curl && PATH=%t/utils:$PATH utils/run_formal_cadence.sh --out-root %t/formal-cadence-webhook-config --interval-secs 0 --iterations 1 --run-formal-all %t/utils/fake-formal-all-fail-immediate.sh --on-fail-webhook-config %t/webhook-config.json --no-strict-gate' 2>&1 | FileCheck %s --check-prefix=CFGFAILFAST
// RUN: cat %t/curl-cfg-call.txt | FileCheck %s --check-prefix=CFGWEBHOOK
// RUN: sh -c 'test "$(grep -c "cfg-a" %t/curl-cfg-call.txt)" -eq 3'
// RUN: sh -c 'test "$(grep -c "cfg-b" %t/curl-cfg-call.txt)" -eq 1'
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\ncat > %t/sendmail.out\nprintf \"%%%%s\\n\" \"$@\" > %t/sendmail.args\n' > %t/utils/sendmail
// RUN: chmod +x %t/utils/sendmail
// RUN: not sh -c 'cd %t && rm -f %t/sendmail.out %t/sendmail.args && PATH=%t/utils:$PATH utils/run_formal_cadence.sh --out-root %t/formal-cadence-email --interval-secs 0 --iterations 1 --run-formal-all %t/utils/fake-formal-all-fail-immediate.sh --on-fail-email formal@example.invalid --sendmail-path %t/utils/sendmail --email-subject-prefix "[cadence-test]" --no-strict-gate' 2>&1 | FileCheck %s --check-prefix=EMAILFAILFAST
// RUN: cat %t/sendmail.args | FileCheck %s --check-prefix=EMAILARGS
// RUN: cat %t/sendmail.out | FileCheck %s --check-prefix=EMAILBODY
//
// PASSLOG: completed_iterations=2
// RETAINLOG: pruned_run_dir=
// AGELOG: pruned_run_dir={{.*run-0000-20000101-000000}}
// FAILFAST: failing fast: iteration 2 failed
// HOOK: hook_invoked=1
// WEBHOOK: formal_cadence_failure
// WEBHOOK: https://example.invalid/formal-a
// WEBHOOK: https://example.invalid/formal-b
// EXPFAILFAST: failing fast: iteration 1 failed
// EXPSLEEP: 2
// EXPSLEEP: 4
// PARFAILFAST: failing fast: iteration 1 failed
// PARLOG: posting on-fail webhooks in parallel: 2 endpoints (max_parallel=1)
// PARWEBHOOK: https://example.invalid/formal-p1
// PARWEBHOOK: https://example.invalid/formal-p2
// CFGFAILFAST: failing fast: iteration 1 failed
// CFGWEBHOOK: https://example.invalid/cfg-a
// CFGWEBHOOK: https://example.invalid/cfg-b
// EMAILFAILFAST: failing fast: iteration 1 failed
// EMAILARGS: -t
// EMAILBODY: To: formal@example.invalid
// EMAILBODY: Subject: [cadence-test] iteration 1 failed (exit 3)
// EMAILBODY: formal cadence failure
