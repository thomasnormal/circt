// RUN: rm -rf %t
// RUN: mkdir -p %t/bin %t/src
// RUN: cp %S/../../utils/run_opentitan_connectivity_circt_lec.py %t/run_opentitan_connectivity_circt_lec.py
// RUN: printf 'target_name\tflow\tsub_flow\tfusesoc_core\trel_path\tbbox_cmd\tconn_csv_count\tconn_csvs\tcfg_file\nchip_earlgrey_asic\tformal\tconn\tlowrisc:systems:chip_earlgrey_asic:0.1\thw/top_earlgrey/formal\t\t1\t[]\t%t/chip_conn_cfg.hjson\n' > %t/target.tsv
// RUN: printf 'rule_id\trule_type\tcsv_file\tcsv_row\trule_name\tsrc_block\tsrc_signal\tdest_block\tdest_signal\nanalog_sigs.csv:FLASH_TEST_MODE_O\tCONNECTION\t%t/analog_sigs.csv\t10\tFLASH_TEST_MODE_O\t\t{FLASH_TEST_MODE1, FLASH_TEST_MODE0}\ttop_earlgrey.u_flash_ctrl.u_eflash.u_flash\tflash_test_mode_a_io\n' > %t/rules.tsv
// RUN: printf 'module u_flash_t(input logic [1:0] flash_test_mode_a_io); endmodule\nmodule u_eflash_t(input logic [1:0] flash_test_mode_a_io); u_flash_t u_flash(.flash_test_mode_a_io(flash_test_mode_a_io)); endmodule\nmodule u_flash_ctrl_t(input logic [1:0] flash_test_mode_a_io); u_eflash_t u_eflash(.flash_test_mode_a_io(flash_test_mode_a_io)); endmodule\nmodule top_earlgrey(input logic [1:0] flash_test_mode_a_io); u_flash_ctrl_t u_flash_ctrl(.flash_test_mode_a_io(flash_test_mode_a_io)); endmodule\n' > %t/src/top_earlgrey.sv
// RUN: printf 'module chip_earlgrey_asic(inout FLASH_TEST_MODE0, inout FLASH_TEST_MODE1); top_earlgrey top_earlgrey(.flash_test_mode_a_io({FLASH_TEST_MODE1, FLASH_TEST_MODE0})); endmodule\n' > %t/src/chip_earlgrey_asic.sv
// RUN: printf '#!/usr/bin/env python3\nimport pathlib, sys\ntarget = sys.argv[sys.argv.index(\"--target\") + 1]\ntool = sys.argv[sys.argv.index(\"--tool\") + 1]\nout_dir = pathlib.Path.cwd() / \"build\" / \"fake\" / f\"{target}-{tool}\"\nout_dir.mkdir(parents=True, exist_ok=True)\n(out_dir / \"fake.eda.yml\").write_text(\"\"\"toplevel: top_earlgrey\\nfiles:\\n- name: %t/src/top_earlgrey.sv\\n  file_type: systemVerilogSource\\n- name: %t/src/chip_earlgrey_asic.sv\\n  file_type: systemVerilogSource\\n\"\"\", encoding=\"utf-8\")\n' > %t/bin/fusesoc
// RUN: printf '#!/usr/bin/env python3\nimport pathlib, sys\nargs = sys.argv[1:]\nchecker = pathlib.Path(args[-1]).read_text(encoding=\"utf-8\")\nif \"chip_earlgrey_asic dut();\" not in checker:\n  raise SystemExit(\"missing chip-wrapper fallback top for unscoped concat source\")\nif \"top_earlgrey dut();\" in checker:\n  raise SystemExit(\"unexpected direct top_earlgrey wrapper top\")\nif \"{dut.FLASH_TEST_MODE1, dut.FLASH_TEST_MODE0}\" not in checker:\n  raise SystemExit(\"missing chip-port scoped source concat\")\nif \"dut.top_earlgrey.u_flash_ctrl.u_eflash.u_flash.flash_test_mode_a_io\" not in checker:\n  raise SystemExit(\"missing destination path scoped under chip wrapper\")\nout = pathlib.Path(args[args.index(\"-o\") + 1])\nout.write_text(\"module {}\\n\", encoding=\"utf-8\")\n' > %t/bin/circt-verilog
// RUN: printf '#!/usr/bin/env python3\nimport pathlib, sys\nargs = sys.argv[1:]\nout = pathlib.Path(args[args.index(\"-o\") + 1])\nout.write_text(pathlib.Path(args[0]).read_text(encoding=\"utf-8\"), encoding=\"utf-8\")\n' > %t/bin/circt-opt
// RUN: printf '#!/usr/bin/env python3\nprint(\"LEC_RESULT=EQ\")\nprint(\"LEC_DIAG=EQ\")\n' > %t/bin/circt-lec
// RUN: chmod +x %t/run_opentitan_connectivity_circt_lec.py %t/bin/fusesoc %t/bin/circt-verilog %t/bin/circt-opt %t/bin/circt-lec
// RUN: LEC_RUN_SMTLIB=0 CIRCT_VERILOG=%t/bin/circt-verilog CIRCT_OPT=%t/bin/circt-opt CIRCT_LEC=%t/bin/circt-lec python3 %t/run_opentitan_connectivity_circt_lec.py --target-manifest %t/target.tsv --rules-manifest %t/rules.tsv --opentitan-root %t --workdir %t/work --rule-filter 'FLASH_TEST_MODE_O' --fusesoc-bin %t/bin/fusesoc --results-file %t/results.tsv
// RUN: FileCheck %s < %t/results.tsv
//
// CHECK: PASS{{[[:space:]]+}}connectivity::analog_sigs.csv:FLASH_TEST_MODE_O{{[[:space:]]+}}{{.*}}opentitan{{[[:space:]]+}}CONNECTIVITY_LEC{{[[:space:]]+}}EQ
