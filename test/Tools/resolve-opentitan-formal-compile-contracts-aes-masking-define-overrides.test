// RUN: rm -rf %t
// RUN: mkdir -p %t/bin %t/ot %t/work
// RUN: printf 'target_name\tfusesoc_core\ttask\tflow\tsub_flow\trel_path\tsource_kind\tsource_cfg_file\troot_cfg_file\naes_masked_sec_cm\tlowrisc:fpv:aes_masked_sec_cm\tFpvSecCm\tformal\tfpv\thw/ip/aes/masking/{sub_flow}/{tool}\tinline\t%t/top.hjson\t%t/top.hjson\naes_unmasked_sec_cm\tlowrisc:fpv:aes_unmasked_sec_cm\tFpvSecCm\tformal\tfpv\thw/ip/aes/unmasking/{sub_flow}/{tool}\tinline\t%t/top.hjson\t%t/top.hjson\n' > %t/manifest.tsv
// RUN: printf '#!/usr/bin/env python3\nimport pathlib,sys\ncore = sys.argv[-1]\ntool = sys.argv[sys.argv.index(\"--tool\") + 1]\ntarget = sys.argv[sys.argv.index(\"--target\") + 1]\ncore_token = core.replace(\":\", \"_\").replace(\".\", \"_\")\nout_dir = pathlib.Path.cwd() / \"build\" / core_token / f\"{target}-{tool}\"\nout_dir.mkdir(parents=True, exist_ok=True)\neda = out_dir / f\"{core_token}.eda.yml\"\neda.write_text(\"\"\"toplevel: aes\\nfiles:\\n- core: lowrisc:ip:aes:1.0\\n  file_type: systemVerilogSource\\n  name: ../src/aes.sv\\n\"\"\")\nprint(\"fake fusesoc setup ok\")\n' > %t/bin/fusesoc
// RUN: chmod +x %t/bin/fusesoc
// RUN: python3 %S/../../utils/resolve_opentitan_formal_compile_contracts.py --manifest %t/manifest.tsv --opentitan-root %t/ot --out-contracts %t/contracts.tsv --workdir %t/work --fusesoc-bin %t/bin/fusesoc
// RUN: python3 -c 'import csv,pathlib,sys; path=pathlib.Path(sys.argv[1]); lines=path.read_text(encoding="utf-8").splitlines(); rows=list(csv.DictReader(lines[1:], delimiter="\t")); by_name={r["target_name"]:r for r in rows}; masked=[x for x in by_name["aes_masked_sec_cm"]["defines"].split(";") if x]; unmasked=[x for x in by_name["aes_unmasked_sec_cm"]["defines"].split(";") if x]; assert "EN_MASKING=1" in masked, masked; assert "EN_MASKING=0" in unmasked, unmasked; assert by_name["aes_masked_sec_cm"]["define_count"] == str(len(masked)), by_name["aes_masked_sec_cm"]["define_count"]; assert by_name["aes_unmasked_sec_cm"]["define_count"] == str(len(unmasked)), by_name["aes_unmasked_sec_cm"]["define_count"]' %t/contracts.tsv
