// RUN: rm -rf %t && mkdir -p %t/proj %t/proj/out %t/scripts
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\nout_dir=\"\"\nwhile [[ $# -gt 0 ]]; do\n  case \"$1\" in\n    --out-dir) out_dir=\"$2\"; shift 2 ;;\n    --out-dir=*) out_dir=\"${1#*=}\"; shift ;;\n    *) shift ;;\n  esac\ndone\nmkdir -p \"$out_dir/lane1\"\nprintf \"total_mutants\\t4\\nrelevant_mutants\\t4\\ndetected_mutants\\t2\\npropagated_not_detected_mutants\\t1\\nnot_propagated_mutants\\t1\\nnot_activated_mutants\\t0\\nerrors\\t0\\nglobal_filter_timeout_mutants\\t0\\nglobal_filter_lec_unknown_mutants\\t0\\nglobal_filter_bmc_unknown_mutants\\t0\\n\" > \"$out_dir/lane1/metrics.tsv\"\nprintf \"lane_id\\tstatus\\texit_code\\tcoverage_percent\\tgate_status\\tlane_dir\\tmetrics_file\\tsummary_json\\n\" > \"$out_dir/results.tsv\"\nprintf \"lane1\\tPASS\\t0\\t50.00\\tPASS\\t$out_dir/lane1\\t$out_dir/lane1/metrics.tsv\\t-\\n\" >> \"$out_dir/results.tsv\"\n' > %t/scripts/run_mutation_matrix.sh
// RUN: chmod +x %t/scripts/run_mutation_matrix.sh
// RUN: printf 'lane1\tdesign.il\tmutations.txt\ttests.tsv\t-\t-\t-\n' > %t/proj/lanes.tsv
// RUN: printf 'run_id\ttimestamp_utc\tkey\tvalue\n1\t2026-02-10T00:00:00Z\tmatrix.detected_mutants_sum\t1\n2\t2026-02-10T01:00:00Z\tmatrix.detected_mutants_sum\t1\n' > %t/proj/out/cli-history.tsv
// RUN: printf 'run_id\ttimestamp_utc\tkey\tvalue\n1\t2026-02-10T00:00:00Z\tmatrix.detected_mutants_sum\t1\n2\t2026-02-10T01:00:00Z\tmatrix.detected_mutants_sum\t2\n3\t2026-02-10T02:00:00Z\tmatrix.detected_mutants_sum\t3\n' > %t/proj/out/cli-trend.tsv
// RUN: printf '[run]\nwith_report = true\nreport_mode = "matrix"\nreport_compare = "out/config-baseline.tsv"\nreport_append_history = "out/config-append.tsv"\nreport_trend_history = "out/config-trend.tsv"\nreport_trend_window = 9\nreport_history_max_runs = 9\n[matrix]\nlanes_tsv = "lanes.tsv"\nout_dir = "out/matrix"\n' > %t/proj/circt-mut.toml
// RUN: env CIRCT_MUT_SCRIPTS_DIR=%t/scripts circt-mut run --project-dir %t/proj --mode matrix --report-compare-history-latest %t/proj/out/cli-history.tsv --report-append-history %t/proj/out/cli-append.tsv --report-trend-history %t/proj/out/cli-trend.tsv --report-trend-window 2 --report-history-max-runs 3 > %t/out.txt
// RUN: FileCheck %s < %t/out.txt
//
// CHECK-DAG: compare.baseline_file{{[[:space:]]}}{{.*}}/cli-history.tsv#run_id=2
// CHECK-DAG: trend.history_file{{[[:space:]]}}{{.*}}/cli-trend.tsv
// CHECK-DAG: trend.history_window_requested{{[[:space:]]}}2
// CHECK-DAG: history.file{{[[:space:]]}}{{.*}}/cli-append.tsv
// CHECK-DAG: history.max_runs{{[[:space:]]}}3
// CHECK-NOT: config-baseline.tsv
// CHECK-NOT: config-append.tsv
// CHECK-NOT: config-trend.tsv
