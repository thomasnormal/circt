// RUN: rm -rf %t
// RUN: mkdir -p %t/utils %t/src %t/work
// RUN: cp %S/../../utils/run_opentitan_fpv_circt_bmc.py %t/utils/run_opentitan_fpv_circt_bmc.py
// RUN: printf '#!/usr/bin/env python3\nimport pathlib,sys\ncases=\"\"\nout=\"\"\nassert_out=\"\"\nargs=sys.argv[1:]\ni=0\nwhile i < len(args):\n  if args[i]==\"--cases-file\":\n    cases=args[i+1]; i+=2; continue\n  if args[i]==\"--results-file\":\n    out=args[i+1]; i+=2; continue\n  if args[i]==\"--assertion-results-file\":\n    assert_out=args[i+1]; i+=2; continue\n  i+=1\nif not cases or not out:\n  raise SystemExit(10)\nrows=[line for line in pathlib.Path(cases).read_text(encoding=\"utf-8\").splitlines() if line.strip()]\nif len(rows)!=2:\n  raise SystemExit(11)\nout_rows=[]\nassert_rows=[]\nfor line in rows:\n  parts=line.split(\"\\t\")\n  case_id=parts[0]\n  case_path=parts[4]\n  out_rows.append(f\"PASS\\t{case_id}\\t{case_path}\\topentitan\\tFPV_BMC\\tUNSAT\")\n  if case_id.startswith(\"foo_fpv::\"):\n    assert_rows.append(f\"FAILING\\t{case_id}\\t{case_path}\\ta0000\\tline_10\\tSAT\\tsat\")\n  elif case_id.startswith(\"bar_fpv::\"):\n    assert_rows.append(f\"PROVEN\\t{case_id}\\t{case_path}\\ta0000\\tline_20\\tUNSAT\\tunsat\")\npathlib.Path(out).write_text(\"\\n\".join(out_rows)+\"\\n\", encoding=\"utf-8\")\nif assert_out:\n  pathlib.Path(assert_out).write_text(\"\\n\".join(assert_rows)+\"\\n\", encoding=\"utf-8\")\n' > %t/utils/run_pairwise_circt_bmc.py
// RUN: chmod +x %t/utils/run_opentitan_fpv_circt_bmc.py %t/utils/run_pairwise_circt_bmc.py
// RUN: touch %t/src/foo.sv %t/src/bar.sv
// RUN: printf '#opentitan_compile_contract_schema_version=1\ntarget_name\tfusesoc_core\ttask\tflow\tsub_flow\trel_path\ttoplevel\tsetup_status\tfile_count\tinclude_dir_count\tdefine_count\tfiles_fingerprint\tinclude_dirs_fingerprint\tdefines_fingerprint\tcontract_fingerprint\tstopat_count\tstopats_fingerprint\tstopats\ttask_profile\ttask_known\tstopat_mode\tblackbox_policy\ttask_policy_fingerprint\tfiles\tinclude_dirs\tdefines\teda_yml_path\tsetup_log_path\tworkdir\nfoo_fpv\tlowrisc:fpv:foo_fpv\tFpvDefault\tformal\tfpv\thw/top_earlgrey/formal/ip/foo\tfoo_tb\tok\t1\t0\t0\tf\ti\td\tc\t0\ts\t\tfpv_default\t1\tnone\tnone\tp\t%t/src/foo.sv\t\t\t/tmp/foo.eda.yml\t/tmp/foo.log\t/tmp/foo.work\nbar_fpv\tlowrisc:fpv:bar_fpv\tFpvSecCm\tformal\tfpv\thw/top_earlgrey/formal/ip/bar\tbar_tb\tok\t1\t0\t0\tf\ti\td\tc\t0\ts\t\tfpv_sec_cm\t1\tnone\tnone\tp\t%t/src/bar.sv\t\t\t/tmp/bar.eda.yml\t/tmp/bar.log\t/tmp/bar.work\n' > %t/contracts.tsv
// RUN: printf 'task_profile\trequired_statuses\tforbidden_statuses\nfpv_default\t\tFAILING\nfpv_sec_cm\tVACUOUS\t\n' > %t/presets.tsv
// RUN: printf 'task_profile\tkind\tstatus\ttarget_count\ttargets\tpolicy_sources\nfpv_default\tforbidden_status_present\tFAILING\t0\t\ttask_profile:fpv_default\n' > %t/grouped-baseline.tsv
// RUN: not sh -c 'OUT=%t/results.tsv %t/utils/run_opentitan_fpv_circt_bmc.py --compile-contracts %t/contracts.tsv --workdir %t/work --assertion-results-file %t/assertions.tsv --assertion-status-policy-task-profile-presets-file %t/presets.tsv --assertion-status-policy-grouped-violations-file %t/grouped.tsv --assertion-status-policy-grouped-violations-baseline-file %t/grouped-baseline.tsv --assertion-status-policy-grouped-violations-drift-file %t/grouped-drift.tsv --fail-on-assertion-status-policy-grouped-violations-drift' 2>&1 | FileCheck %s --check-prefix=LOG
// RUN: FileCheck %s --check-prefix=DIFF < %t/grouped-drift.tsv
//
// LOG: grouped violations drift detected
// DIFF: task_profile{{[[:space:]]+}}violation_kind{{[[:space:]]+}}status{{[[:space:]]+}}kind{{[[:space:]]+}}baseline{{[[:space:]]+}}current
// DIFF-DAG: fpv_default{{[[:space:]]+}}forbidden_status_present{{[[:space:]]+}}FAILING{{[[:space:]]+}}target_count{{[[:space:]]+}}0{{[[:space:]]+}}1
// DIFF-DAG: fpv_sec_cm{{[[:space:]]+}}required_status_missing{{[[:space:]]+}}VACUOUS{{[[:space:]]+}}new_group_row{{[[:space:]]+}}absent{{[[:space:]]+}}fpv_sec_cm::required_status_missing::VACUOUS
