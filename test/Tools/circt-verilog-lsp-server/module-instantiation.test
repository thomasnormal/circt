// RUN: circt-verilog-lsp-server -lit-test < %s | FileCheck %s
// REQUIRES: slang
// UNSUPPORTED: valgrind
// Test LSP functionality for module instantiation and hierarchy navigation.
{"jsonrpc":"2.0","id":0,"method":"initialize","params":{"processId":123,"rootPath":"verilog","capabilities":{"textDocument":{"documentSymbol":{"hierarchicalDocumentSymbolSupport":true}}},"trace":"off"}}
// -----
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{
  "uri":"test:///hierarchy.sv",
  "languageId":"verilog",
  "version":1,
  "text":"module adder #(\n  parameter WIDTH = 8\n) (\n  input  logic [WIDTH-1:0] a,\n  input  logic [WIDTH-1:0] b,\n  output logic [WIDTH-1:0] sum\n);\n  assign sum = a + b;\nendmodule\n\nmodule top_level (\n  input  logic clk,\n  input  logic [7:0] operand_a,\n  input  logic [7:0] operand_b,\n  output logic [7:0] result\n);\n  adder #(.WIDTH(8)) u_adder (\n    .a(operand_a),\n    .b(operand_b),\n    .sum(result)\n  );\nendmodule"
}}}
// -----
// Document symbols should show hierarchy
{"jsonrpc":"2.0","id":1,"method":"textDocument/documentSymbol","params":{
  "textDocument":{"uri":"test:///hierarchy.sv"}
}}
// CHECK:       "id": 1,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK:       "result": [
// Document symbols include module with children (ports, instances)
// u_adder instance is listed in children before parent module name
// CHECK:         "name": "u_adder"
// CHECK:         "name": "top_level"
// -----
// Go to definition of 'adder' module (from instantiation line 16, col 2)
{"jsonrpc":"2.0","id":2,"method":"textDocument/definition","params":{
  "textDocument":{"uri":"test:///hierarchy.sv"},
  "position":{"line":16,"character":4}
}}
// CHECK:       "id": 2,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": [
// Should navigate to adder module definition (line 0 is the module declaration)
// CHECK:         "line": 0
// CHECK:         "uri": "test:///hierarchy.sv"
// -----
// Hover over instance name 'u_adder' (line 16, col 21)
{"jsonrpc":"2.0","id":3,"method":"textDocument/hover","params":{
  "textDocument":{"uri":"test:///hierarchy.sv"},
  "position":{"line":16,"character":21}
}}
// CHECK:       "id": 3,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": {
// CHECK:           "value": "```systemverilog
// Should show instance type info
// CHECK:           adder
// -----
// Go to definition of parameter WIDTH usage (line 16, col 10)
{"jsonrpc":"2.0","id":4,"method":"textDocument/definition","params":{
  "textDocument":{"uri":"test:///hierarchy.sv"},
  "position":{"line":16,"character":13}
}}
// CHECK:       "id": 4,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result":
// -----
{"jsonrpc":"2.0","id":5,"method":"shutdown"}
// -----
{"jsonrpc":"2.0","method":"exit"}
