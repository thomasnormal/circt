// RUN: circt-verilog-lsp-server -lit-test < %s | FileCheck %s
// REQUIRES: slang
// Test comprehensive diagnostics publishing with errors, warnings, and updates

// Test 1: Error diagnostic on document open
{"jsonrpc":"2.0","id":0,"method":"initialize","params":{"processId":123,"rootPath":"verilog","capabilities":{},"trace":"off"}}
// -----
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"test:///error.sv","languageId":"systemverilog","version":1,"text":"module test;\n  wire x\nendmodule"}}}

// CHECK: "method": "textDocument/publishDiagnostics"
// CHECK-NEXT: "params": {
// CHECK-NEXT:   "diagnostics": [
// CHECK-NEXT:     {
// Diagnostics now include category field
// CHECK:            "category": "Parse Error"
// CHECK:            "message": "expected ';'"
// CHECK:            "severity": 1
// CHECK:            "source": "slang"

// Test 2: Warning diagnostic on document change
// -----
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"test:///error.sv","version":2},"contentChanges":[{"text":"module test;\n  logic [7:0] a;\n  logic [15:0] b;\n  initial b = a;\nendmodule"}]}}

// CHECK: "method": "textDocument/publishDiagnostics"
// CHECK: "diagnostics": [
// CHECK:   {
// CHECK:     "message": "implicit conversion expands from 8 to 16 bits"
// CHECK:     "severity": 2

// Test 3: No diagnostics after fixing the code
// -----
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"test:///error.sv","version":3},"contentChanges":[{"text":"module test;\n  logic a;\nendmodule"}]}}

// CHECK: "method": "textDocument/publishDiagnostics"
// CHECK: "diagnostics": []
// CHECK: "uri": "test:///error.sv"
// CHECK: "version": 3

// -----
{"jsonrpc":"2.0","id":1,"method":"shutdown"}
// -----
{"jsonrpc":"2.0","method":"exit"}
