// RUN: circt-verilog-lsp-server -lit-test < %s | FileCheck %s
// REQUIRES: slang
// UNSUPPORTED: valgrind
// Test code action functionality for quick fixes and refactorings.
{"jsonrpc":"2.0","id":0,"method":"initialize","params":{"processId":123,"rootPath":"verilog","capabilities":{"textDocument":{"codeAction":{"codeActionLiteralSupport":true}}},"trace":"off"}}
// -----
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{
  "uri":"test:///codeaction.sv",
  "languageId":"verilog",
  "version":1,
  "text":"module test_mod (\n  input  logic clk,\n  output logic [7:0] data_out\n);\n  assign data_out = counter;\nendmodule"
}}}
// -----
// Request code actions for a selection (should return refactoring actions)
{"jsonrpc":"2.0","id":1,"method":"textDocument/codeAction","params":{
  "textDocument":{"uri":"test:///codeaction.sv"},
  "range":{"start":{"line":4,"character":20},"end":{"line":4,"character":27}},
  "context":{"diagnostics":[]}
}}
// CHECK:       "id": 1,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": [
// Should include refactoring action for extract to signal
// CHECK:         "kind": "refactor"
// CHECK:         "title": "Extract to signal"
// -----
// Request code actions with a diagnostic about unknown identifier
{"jsonrpc":"2.0","id":2,"method":"textDocument/codeAction","params":{
  "textDocument":{"uri":"test:///codeaction.sv"},
  "range":{"start":{"line":4,"character":20},"end":{"line":4,"character":27}},
  "context":{"diagnostics":[
    {"range":{"start":{"line":4,"character":20},"end":{"line":4,"character":27}},
     "message":"use of undeclared identifier 'counter'",
     "severity":1}
  ]}
}}
// CHECK:       "id": 2,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": [
// Should include quick fix suggestions for undeclared identifier with proper titles
// CHECK:         "kind": "quickfix"
// CHECK:         "title": "Declare 'counter' as wire"
// CHECK:         "title": "Declare 'counter' as logic"
// CHECK:         "title": "Declare 'counter' as reg"
// -----
// Test that quick fixes include workspace edits with text changes
{"jsonrpc":"2.0","id":3,"method":"textDocument/codeAction","params":{
  "textDocument":{"uri":"test:///codeaction.sv"},
  "range":{"start":{"line":4,"character":20},"end":{"line":4,"character":27}},
  "context":{"diagnostics":[
    {"range":{"start":{"line":4,"character":20},"end":{"line":4,"character":27}},
     "message":"unknown identifier 'my_signal'",
     "severity":1}
  ]}
}}
// CHECK:       "id": 3,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": [
// Should include workspace edits
// CHECK:         "edit":
// CHECK:           "changes":
// CHECK:             "test:///codeaction.sv":
// CHECK:               "newText": "  wire my_signal;
// -----
// Test code action for width mismatch diagnostic
{"jsonrpc":"2.0","id":4,"method":"textDocument/codeAction","params":{
  "textDocument":{"uri":"test:///codeaction.sv"},
  "range":{"start":{"line":4,"character":20},"end":{"line":4,"character":27}},
  "context":{"diagnostics":[
    {"range":{"start":{"line":4,"character":20},"end":{"line":4,"character":27}},
     "message":"width mismatch in assignment",
     "severity":2}
  ]}
}}
// CHECK:       "id": 4,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": [
// Should include truncation and extension quick fixes
// CHECK:         "kind": "quickfix"
// CHECK:         "title": "Add explicit truncation"
// CHECK:         "title": "Add explicit zero-extension"
// -----
// Test code action for unknown module diagnostic
{"jsonrpc":"2.0","id":5,"method":"textDocument/codeAction","params":{
  "textDocument":{"uri":"test:///codeaction.sv"},
  "range":{"start":{"line":4,"character":0},"end":{"line":4,"character":10}},
  "context":{"diagnostics":[
    {"range":{"start":{"line":4,"character":0},"end":{"line":4,"character":10}},
     "message":"unknown module 'submodule'",
     "severity":1}
  ]}
}}
// CHECK:       "id": 5,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": [
// Should include create module stub quick fix
// CHECK:         "kind": "quickfix"
// CHECK:         "title": "Create module stub for 'submodule'"
// -----
// Test code action for missing import (UVM types)
{"jsonrpc":"2.0","id":6,"method":"textDocument/codeAction","params":{
  "textDocument":{"uri":"test:///codeaction.sv"},
  "range":{"start":{"line":0,"character":0},"end":{"line":0,"character":10}},
  "context":{"diagnostics":[
    {"range":{"start":{"line":0,"character":0},"end":{"line":0,"character":10}},
     "message":"unknown type 'uvm_component'",
     "severity":1}
  ]}
}}
// CHECK:       "id": 6,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": [
// Should include add import quick fix for uvm_pkg
// CHECK:         "kind": "quickfix"
// CHECK:         "title": "Add 'import uvm_pkg::*;'"
// -----
// Test that logic declaration is marked as preferred
{"jsonrpc":"2.0","id":7,"method":"textDocument/codeAction","params":{
  "textDocument":{"uri":"test:///codeaction.sv"},
  "range":{"start":{"line":4,"character":20},"end":{"line":4,"character":27}},
  "context":{"diagnostics":[
    {"range":{"start":{"line":4,"character":20},"end":{"line":4,"character":27}},
     "message":"use of undeclared identifier 'counter'",
     "severity":1}
  ]}
}}
// CHECK:       "id": 7,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": [
// The logic declaration should be marked as preferred
// CHECK:         "isPreferred": true,
// CHECK-NEXT:    "kind": "quickfix",
// CHECK-NEXT:    "title": "Declare 'counter' as logic"
// -----
// Test code action for missing semicolon
{"jsonrpc":"2.0","id":8,"method":"textDocument/codeAction","params":{
  "textDocument":{"uri":"test:///codeaction.sv"},
  "range":{"start":{"line":4,"character":26},"end":{"line":4,"character":27}},
  "context":{"diagnostics":[
    {"range":{"start":{"line":4,"character":26},"end":{"line":4,"character":27}},
     "message":"expected ';' at end of statement",
     "severity":1}
  ]}
}}
// CHECK:       "id": 8
// CHECK:       "result": [
// Should include insert semicolon quick fix
// CHECK:         "isPreferred": true
// CHECK:         "kind": "quickfix"
// CHECK:         "title": "Insert missing semicolon"
// -----
// Test code action for common typo 'rge' -> 'reg'
{"jsonrpc":"2.0","id":9,"method":"textDocument/codeAction","params":{
  "textDocument":{"uri":"test:///codeaction.sv"},
  "range":{"start":{"line":1,"character":2},"end":{"line":1,"character":5}},
  "context":{"diagnostics":[
    {"range":{"start":{"line":1,"character":2},"end":{"line":1,"character":5}},
     "message":"unknown type 'rge'",
     "severity":1}
  ]}
}}
// CHECK:       "id": 9
// CHECK:       "result": [
// Should include typo fix for rge -> reg
// CHECK:         "isPreferred": true
// CHECK:         "kind": "quickfix"
// CHECK:         "title": "Fix typo: 'rge' -> 'reg'"
// -----
// Test code action for common typo 'wrie' -> 'wire'
{"jsonrpc":"2.0","id":10,"method":"textDocument/codeAction","params":{
  "textDocument":{"uri":"test:///codeaction.sv"},
  "range":{"start":{"line":1,"character":2},"end":{"line":1,"character":6}},
  "context":{"diagnostics":[
    {"range":{"start":{"line":1,"character":2},"end":{"line":1,"character":6}},
     "message":"unexpected token 'wrie'",
     "severity":1}
  ]}
}}
// CHECK:       "id": 10
// CHECK:       "result": [
// Should include typo fix for wrie -> wire
// CHECK:         "kind": "quickfix"
// CHECK:         "title": "Fix typo: 'wrie' -> 'wire'"
// -----
// Test code action for common typo 'lgic' -> 'logic'
{"jsonrpc":"2.0","id":11,"method":"textDocument/codeAction","params":{
  "textDocument":{"uri":"test:///codeaction.sv"},
  "range":{"start":{"line":1,"character":2},"end":{"line":1,"character":6}},
  "context":{"diagnostics":[
    {"range":{"start":{"line":1,"character":2},"end":{"line":1,"character":6}},
     "message":"unknown type 'lgic'",
     "severity":1}
  ]}
}}
// CHECK:       "id": 11
// CHECK:       "result": [
// Should include typo fix for lgic -> logic
// CHECK:         "kind": "quickfix"
// CHECK:         "title": "Fix typo: 'lgic' -> 'logic'"
// -----
// Test code action for common typo 'alwyas' -> 'always'
{"jsonrpc":"2.0","id":12,"method":"textDocument/codeAction","params":{
  "textDocument":{"uri":"test:///codeaction.sv"},
  "range":{"start":{"line":4,"character":2},"end":{"line":4,"character":8}},
  "context":{"diagnostics":[
    {"range":{"start":{"line":4,"character":2},"end":{"line":4,"character":8}},
     "message":"unknown keyword 'alwyas'",
     "severity":1}
  ]}
}}
// CHECK:       "id": 12
// CHECK:       "result": [
// Should include typo fix for alwyas -> always
// CHECK:         "kind": "quickfix"
// CHECK:         "title": "Fix typo: 'alwyas' -> 'always'"
// -----
// Test code action for common typo 'modle' -> 'module'
{"jsonrpc":"2.0","id":13,"method":"textDocument/codeAction","params":{
  "textDocument":{"uri":"test:///codeaction.sv"},
  "range":{"start":{"line":0,"character":0},"end":{"line":0,"character":5}},
  "context":{"diagnostics":[
    {"range":{"start":{"line":0,"character":0},"end":{"line":0,"character":5}},
     "message":"expected module declaration but found 'modle'",
     "severity":1}
  ]}
}}
// CHECK:       "id": 13
// CHECK:       "result": [
// Should include typo fix for modle -> module
// CHECK:         "kind": "quickfix"
// CHECK:         "title": "Fix typo: 'modle' -> 'module'"
// -----
// Test code action for begin/end block needed
{"jsonrpc":"2.0","id":14,"method":"textDocument/codeAction","params":{
  "textDocument":{"uri":"test:///codeaction.sv"},
  "range":{"start":{"line":4,"character":4},"end":{"line":4,"character":20}},
  "context":{"diagnostics":[
    {"range":{"start":{"line":4,"character":4},"end":{"line":4,"character":20}},
     "message":"expected single statement after 'if', use begin/end for multiple statements",
     "severity":1}
  ]}
}}
// CHECK:       "id": 14
// CHECK:       "result": [
// Should include wrap in begin/end quick fix
// CHECK:         "kind": "quickfix"
// CHECK:         "title": "Wrap in begin/end block"
// -----
// Test code action for missing semicolon with alternate message format
{"jsonrpc":"2.0","id":15,"method":"textDocument/codeAction","params":{
  "textDocument":{"uri":"test:///codeaction.sv"},
  "range":{"start":{"line":4,"character":26},"end":{"line":4,"character":27}},
  "context":{"diagnostics":[
    {"range":{"start":{"line":4,"character":26},"end":{"line":4,"character":27}},
     "message":"missing semicolon after statement",
     "severity":1}
  ]}
}}
// CHECK:       "id": 15
// CHECK:       "result": [
// Should include insert semicolon quick fix
// CHECK:         "kind": "quickfix"
// CHECK:         "title": "Insert missing semicolon"
// -----
{"jsonrpc":"2.0","id":99,"method":"shutdown"}
// -----
{"jsonrpc":"2.0","method":"exit"}
