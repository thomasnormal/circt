// RUN: circt-verilog-lsp-server -lit-test < %s | FileCheck %s
// REQUIRES: slang
// UNSUPPORTED: valgrind
// Test semantic tokens functionality for Verilog/SystemVerilog.
// This tests that the LSP server properly returns semantic tokens for:
// - Keywords (module, always_ff, input, output, etc.)
// - Types (logic, int, etc.)
// - Variables/signals
// - Parameters
// - Numbers/literals
// - Strings
// - Operators

{"jsonrpc":"2.0","id":0,"method":"initialize","params":{"processId":123,"rootPath":"verilog","capabilities":{},"trace":"off"}}
// CHECK:       "id": 0,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": {
// CHECK:         "semanticTokensProvider": {
// CHECK:           "full": true
// CHECK:           "legend": {
// CHECK:             "tokenModifiers":
// CHECK:             "tokenTypes":
// -----
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{
  "uri":"test:///tokens.sv",
  "languageId":"verilog",
  "version":1,
  "text":"module counter #(parameter WIDTH = 8) (\n  input  logic clk,\n  input  logic rst,\n  output logic [WIDTH-1:0] count\n);\n  logic [WIDTH-1:0] counter_reg;\n  always_ff @(posedge clk or negedge rst) begin\n    if (!rst)\n      counter_reg <= '0;\n    else\n      counter_reg <= counter_reg + 1'b1;\n  end\n  assign count = counter_reg;\nendmodule"
}}}
// -----
// Request semantic tokens for the entire document
{"jsonrpc":"2.0","id":1,"method":"textDocument/semanticTokens/full","params":{
  "textDocument":{"uri":"test:///tokens.sv"}
}}
// CHECK:       "id": 1,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": {
// CHECK-NEXT:    "data": [
// The data array contains encoded semantic tokens:
// Each token is encoded as 5 integers: deltaLine, deltaStartChar, length, tokenType, tokenModifiers
// Verify we get some tokens (non-empty data array)
// CHECK:         0,
// CHECK:         ]
// CHECK-NEXT:  }
// -----
// Test a more complex file with packages and classes
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{
  "uri":"test:///complex.sv",
  "languageId":"verilog",
  "version":1,
  "text":"package my_pkg;\n  typedef struct packed {\n    logic [7:0] data;\n    logic       valid;\n  } data_t;\n  \n  localparam int TIMEOUT = 100;\nendpackage\n\nmodule test import my_pkg::*; (\n  input  logic clk,\n  output data_t result\n);\n  // Line comment test\n  /* Block\n     comment */\n  string msg = \"Hello World\";\n  assign result.valid = 1'b1;\nendmodule"
}}}
// -----
{"jsonrpc":"2.0","id":2,"method":"textDocument/semanticTokens/full","params":{
  "textDocument":{"uri":"test:///complex.sv"}
}}
// CHECK:       "id": 2,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": {
// CHECK-NEXT:    "data": [
// Verify we get tokens for the complex file
// CHECK:         0,
// CHECK:         ]
// CHECK-NEXT:  }
// -----
// Test classes with methods (UVM-style)
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{
  "uri":"test:///class.sv",
  "languageId":"verilog",
  "version":1,
  "text":"class my_transaction;\n  rand bit [7:0] data;\n  rand bit [3:0] addr;\n  constraint valid_addr { addr < 10; }\n  function void display();\n    $display(\"data=%0d\", data);\n  endfunction\nendclass"
}}}
// -----
{"jsonrpc":"2.0","id":3,"method":"textDocument/semanticTokens/full","params":{
  "textDocument":{"uri":"test:///class.sv"}
}}
// CHECK:       "id": 3,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": {
// CHECK-NEXT:    "data": [
// Verify we get tokens for class, rand, constraint, function keywords
// CHECK:         0,
// CHECK:         ]
// CHECK-NEXT:  }
// -----
// Test interface with modports
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{
  "uri":"test:///iface.sv",
  "languageId":"verilog",
  "version":1,
  "text":"interface simple_bus;\n  logic req, gnt;\n  logic [7:0] addr, data;\n  modport master(output req, addr, input gnt, data);\n  modport slave(input req, addr, output gnt, data);\nendinterface"
}}}
// -----
{"jsonrpc":"2.0","id":4,"method":"textDocument/semanticTokens/full","params":{
  "textDocument":{"uri":"test:///iface.sv"}
}}
// CHECK:       "id": 4,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": {
// CHECK-NEXT:    "data": [
// Verify tokens for interface, modport keywords
// CHECK:         0,
// CHECK:         ]
// CHECK-NEXT:  }
// -----
{"jsonrpc":"2.0","id":5,"method":"shutdown"}
// -----
{"jsonrpc":"2.0","method":"exit"}
