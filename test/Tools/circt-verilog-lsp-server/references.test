// RUN: circt-verilog-lsp-server -lit-test < %s | FileCheck %s
// REQUIRES: slang
// UNSUPPORTED: valgrind
// Test comprehensive textDocument/references functionality across various symbol types.
{"jsonrpc":"2.0","id":0,"method":"initialize","params":{"processId":123,"rootPath":"verilog","capabilities":{},"trace":"off"}}
// -----
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{
  "uri":"test:///refs_test.sv",
  "languageId":"verilog",
  "version":1,
  "text":"module counter #(\n  parameter int WIDTH = 8\n) (\n  input  logic clk,\n  input  logic rst_n,\n  input  logic enable,\n  output logic [WIDTH-1:0] count\n);\n  logic [WIDTH-1:0] next_count;\n  \n  always_ff @(posedge clk or negedge rst_n) begin\n    if (!rst_n)\n      count <= '0;\n    else if (enable)\n      count <= next_count;\n  end\n  \n  assign next_count = count + 1;\nendmodule\n\nmodule top;\n  logic clk, rst_n, en;\n  logic [7:0] counter_val;\n  \n  counter #(.WIDTH(8)) u_counter (\n    .clk(clk),\n    .rst_n(rst_n),\n    .enable(en),\n    .count(counter_val)\n  );\nendmodule"
}}}
// -----
// Test 1: Find all references to 'count' output port (line 6, col 27)
// Should find: declaration, all assignments and usages
{"jsonrpc":"2.0","id":1,"method":"textDocument/references","params":{
  "textDocument":{"uri":"test:///refs_test.sv"},
  "position":{"line":6,"character":27},
  "context":{"includeDeclaration":true}
}}
// CHECK:       "id": 1,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": [
// CHECK:         "uri": "test:///refs_test.sv"
// Should find multiple references to 'count'
// CHECK:       ]
// -----
// Test 2: Find all references to 'WIDTH' parameter (line 1, col 20)
// Should find: declaration and all usages
{"jsonrpc":"2.0","id":2,"method":"textDocument/references","params":{
  "textDocument":{"uri":"test:///refs_test.sv"},
  "position":{"line":1,"character":20},
  "context":{"includeDeclaration":true}
}}
// CHECK:       "id": 2,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": [
// CHECK:         "uri": "test:///refs_test.sv"
// Should find references to WIDTH parameter
// CHECK:       ]
// -----
// Test 3: Find all references to 'clk' signal (line 3, col 15)
// Should find: port declaration and usage in always_ff
{"jsonrpc":"2.0","id":3,"method":"textDocument/references","params":{
  "textDocument":{"uri":"test:///refs_test.sv"},
  "position":{"line":3,"character":15},
  "context":{"includeDeclaration":true}
}}
// CHECK:       "id": 3,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": [
// CHECK:         "uri": "test:///refs_test.sv"
// CHECK:       ]
// -----
// Test 4: Find all references to 'next_count' internal signal (line 8, col 23)
// Should find: declaration and usages in assignment and expression
{"jsonrpc":"2.0","id":4,"method":"textDocument/references","params":{
  "textDocument":{"uri":"test:///refs_test.sv"},
  "position":{"line":8,"character":23},
  "context":{"includeDeclaration":true}
}}
// CHECK:       "id": 4,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": [
// CHECK:         "uri": "test:///refs_test.sv"
// CHECK:       ]
// -----
// Test 5: Find all references to 'enable' port (line 5, col 15)
{"jsonrpc":"2.0","id":5,"method":"textDocument/references","params":{
  "textDocument":{"uri":"test:///refs_test.sv"},
  "position":{"line":5,"character":15},
  "context":{"includeDeclaration":true}
}}
// CHECK:       "id": 5,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": [
// CHECK:         "uri": "test:///refs_test.sv"
// CHECK:       ]
// -----
// Test 6: Find references with includeDeclaration=false
// Should find only usages, not the declaration
{"jsonrpc":"2.0","id":6,"method":"textDocument/references","params":{
  "textDocument":{"uri":"test:///refs_test.sv"},
  "position":{"line":8,"character":23},
  "context":{"includeDeclaration":false}
}}
// CHECK:       "id": 6,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": [
// CHECK:         "uri": "test:///refs_test.sv"
// CHECK:       ]
// -----
// Open a second file to test function references
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{
  "uri":"test:///func_test.sv",
  "languageId":"verilog",
  "version":1,
  "text":"module func_test;\n  function int add(int a, int b);\n    return a + b;\n  endfunction\n  \n  int result1, result2, result3;\n  \n  initial begin\n    result1 = add(1, 2);\n    result2 = add(3, 4);\n    result3 = add(result1, result2);\n  end\nendmodule"
}}}
// -----
// Test 7: Find all references to 'add' function (line 1, col 15)
// Should find: function declaration and all call sites
{"jsonrpc":"2.0","id":7,"method":"textDocument/references","params":{
  "textDocument":{"uri":"test:///func_test.sv"},
  "position":{"line":1,"character":15},
  "context":{"includeDeclaration":true}
}}
// CHECK:       "id": 7,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": [
// Should find function declaration and 3 call sites (4 total)
// CHECK:         "uri": "test:///func_test.sv"
// CHECK:         "uri": "test:///func_test.sv"
// CHECK:         "uri": "test:///func_test.sv"
// CHECK:         "uri": "test:///func_test.sv"
// CHECK:       ]
// -----
// Test 8: Find references to function without declaration
{"jsonrpc":"2.0","id":8,"method":"textDocument/references","params":{
  "textDocument":{"uri":"test:///func_test.sv"},
  "position":{"line":1,"character":15},
  "context":{"includeDeclaration":false}
}}
// CHECK:       "id": 8,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": [
// Should find only 3 call sites (no declaration)
// CHECK:         "uri": "test:///func_test.sv"
// CHECK:         "uri": "test:///func_test.sv"
// CHECK:         "uri": "test:///func_test.sv"
// CHECK:       ]
// -----
{"jsonrpc":"2.0","id":9,"method":"shutdown"}
// -----
{"jsonrpc":"2.0","method":"exit"}
