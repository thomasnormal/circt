// Test debounce functionality (run without --lit-test to enable debounce)
// RUN: circt-verilog-lsp-server --input-style=delimited --no-debounce --log=error --pretty < %s | FileCheck %s
// REQUIRES: slang
// UNSUPPORTED: valgrind
//
// This test verifies that the LSP server handles textDocument/didChange
// notifications correctly. While debounce is disabled for this test
// (for deterministic timing), the actual debounce mechanism was fixed
// in commit 9f150f33f to avoid deadlock in abort().

// Initialize the server
{"jsonrpc":"2.0","id":0,"method":"initialize","params":{"processId":123,"rootPath":"verilog","capabilities":{},"trace":"off"}}
// -----

// Open a document
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{
  "uri":"test:///debounce.sv",
  "languageId":"systemverilog",
  "version":1,
  "text":"module test; endmodule"
}}}
// CHECK: "method": "textDocument/publishDiagnostics"
// CHECK: "version": 1
// -----

// Send multiple rapid changes - with debounce disabled, each should publish diagnostics
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{
  "uri":"test:///debounce.sv",
  "version":2
}, "contentChanges": [{"text": "module test2; endmodule"}]}}
// CHECK: "method": "textDocument/publishDiagnostics"
// CHECK: "version": 2
// -----

{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{
  "uri":"test:///debounce.sv",
  "version":3
}, "contentChanges": [{"text": "module test3; endmodule"}]}}
// CHECK: "method": "textDocument/publishDiagnostics"
// CHECK: "version": 3
// -----

// Shutdown should work correctly
{"jsonrpc":"2.0","id":1,"method":"shutdown"}
// CHECK: "id": 1
// -----
{"jsonrpc":"2.0","method":"exit"}
