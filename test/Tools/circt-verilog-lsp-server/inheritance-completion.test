// RUN: circt-verilog-lsp-server -lit-test < %s | FileCheck %s
// REQUIRES: slang
// UNSUPPORTED: valgrind
// Test inheritance-aware completion for class members.
{"jsonrpc":"2.0","id":0,"method":"initialize","params":{"processId":123,"rootPath":"verilog","capabilities":{},"trace":"off"}}
// -----
// Test simple single inheritance
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{
  "uri":"test:///single_inheritance.sv",
  "languageId":"systemverilog",
  "version":1,
  "text":"class BaseClass;\n  int base_field;\n  function void base_method();\n  endfunction\nendclass\n\nclass DerivedClass extends BaseClass;\n  int derived_field;\n  function void derived_method();\n  endfunction\nendclass\n\nmodule test;\n  DerivedClass obj;\n  initial begin\n    obj.\n  end\nendmodule"
}}}
// -----
// Request completion after "obj." - should show both derived and inherited members
{"jsonrpc":"2.0","id":1,"method":"textDocument/completion","params":{
  "textDocument":{"uri":"test:///single_inheritance.sv"},
  "position":{"line":15,"character":8}
}}
// CHECK:       "id": 1,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": {
// CHECK:         "isIncomplete": false,
// CHECK:         "items": [
// Should include inherited members with "from BaseClass" annotation
// CHECK:           "detail": "function (from BaseClass)"
// CHECK:           "label": "base_method"
// CHECK:           "detail": "(from BaseClass)"
// CHECK:           "label": "base_field"
// Should include derived class members (no annotation)
// CHECK:           "label": "derived_field"
// CHECK:           "detail": "function"
// CHECK:           "label": "derived_method"
// -----
// Test multi-level inheritance (grandparent -> parent -> child)
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{
  "uri":"test:///multi_inheritance.sv",
  "languageId":"systemverilog",
  "version":1,
  "text":"class GrandParent;\n  int gp_field;\n  function void gp_method();\n  endfunction\nendclass\n\nclass Parent extends GrandParent;\n  int parent_field;\n  function void parent_method();\n  endfunction\nendclass\n\nclass Child extends Parent;\n  int child_field;\n  function void child_method();\n  endfunction\nendclass\n\nmodule test;\n  Child obj;\n  initial begin\n    obj.\n  end\nendmodule"
}}}
// -----
// Request completion - should include all levels of inheritance
{"jsonrpc":"2.0","id":2,"method":"textDocument/completion","params":{
  "textDocument":{"uri":"test:///multi_inheritance.sv"},
  "position":{"line":21,"character":8}
}}
// CHECK:       "id": 2,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": {
// CHECK:         "isIncomplete": false,
// CHECK:         "items": [
// Should include parent members with annotation
// CHECK:           "detail": "function (from Parent)"
// CHECK:           "label": "parent_method"
// CHECK:           "detail": "(from Parent)"
// CHECK:           "label": "parent_field"
// Should include grandparent members with annotation
// CHECK:           "detail": "(from GrandParent)"
// CHECK:           "label": "gp_field"
// CHECK:           "detail": "function (from GrandParent)"
// CHECK:           "label": "gp_method"
// Should include child class members (no annotation)
// CHECK:           "label": "child_field"
// CHECK:           "detail": "function"
// CHECK:           "label": "child_method"
// -----
// Test interface class implementation
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{
  "uri":"test:///interface_impl.sv",
  "languageId":"systemverilog",
  "version":1,
  "text":"interface class IBase;\n  pure virtual function void iface_method();\nendclass\n\nclass Impl implements IBase;\n  int impl_field;\n  virtual function void iface_method();\n  endfunction\nendclass\n\nmodule test;\n  Impl obj;\n  initial begin\n    obj.\n  end\nendmodule"
}}}
// -----
// Request completion - should include members from implementing class
// Note: iface_method is defined in Impl (implementation), not inherited
{"jsonrpc":"2.0","id":3,"method":"textDocument/completion","params":{
  "textDocument":{"uri":"test:///interface_impl.sv"},
  "position":{"line":13,"character":8}
}}
// CHECK:       "id": 3,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": {
// CHECK:         "isIncomplete": false,
// CHECK:         "items": [
// Should include implementation class members
// CHECK:           "label": "impl_field"
// CHECK:           "detail": "function"
// CHECK:           "label": "iface_method"
// -----
// Test method override (derived method should shadow base method)
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{
  "uri":"test:///method_override.sv",
  "languageId":"systemverilog",
  "version":1,
  "text":"class Base;\n  int shared_field;\n  virtual function void shared_method();\n  endfunction\nendclass\n\nclass Derived extends Base;\n  virtual function void shared_method();\n  endfunction\nendclass\n\nmodule test;\n  Derived obj;\n  initial begin\n    obj.\n  end\nendmodule"
}}}
// -----
// Request completion - overridden method should only appear once (from derived)
{"jsonrpc":"2.0","id":4,"method":"textDocument/completion","params":{
  "textDocument":{"uri":"test:///method_override.sv"},
  "position":{"line":14,"character":8}
}}
// CHECK:       "id": 4,
// CHECK-NEXT:  "jsonrpc": "2.0",
// CHECK-NEXT:  "result": {
// CHECK:         "isIncomplete": false,
// CHECK:         "items": [
// The shared_field should have "(from Base)" annotation
// CHECK:           "detail": "(from Base)"
// CHECK:           "label": "shared_field"
// The shared_method should appear without "(from Base)" since it's overridden
// CHECK:           "detail": "function"
// CHECK:           "label": "shared_method"
// -----
{"jsonrpc":"2.0","id":99,"method":"shutdown"}
// -----
{"jsonrpc":"2.0","method":"exit"}
