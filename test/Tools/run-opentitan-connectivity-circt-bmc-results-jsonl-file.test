// RUN: rm -rf %t
// RUN: mkdir -p %t/bin %t/src
// RUN: cp %S/../../utils/run_opentitan_connectivity_circt_bmc.py %t/run_opentitan_connectivity_circt_bmc.py
// RUN: printf 'target_name\tflow\tsub_flow\tfusesoc_core\trel_path\tbbox_cmd\tconn_csv_count\tconn_csvs\tcfg_file\nchip_earlgrey_asic\tformal\tconn\tlowrisc:systems:chip_earlgrey_asic:0.1\thw/top_earlgrey/formal\t\t1\t[]\t%t/chip_conn_cfg.hjson\n' > %t/target.tsv
// RUN: printf 'rule_id\trule_type\tcsv_file\tcsv_row\trule_name\tsrc_block\tsrc_signal\tdest_block\tdest_signal\nchip.csv:RULE_CLK\tCONNECTION\t%t/chip.csv\t10\tRULE_CLK\ttop_earlgrey.u_src\tclk_o\ttop_earlgrey.u_dst\tclk_i\n' > %t/rules.tsv
// RUN: printf 'module top_earlgrey;\n  u_src_t u_src();\n  u_dst_t u_dst();\nendmodule\nmodule u_src_t; logic clk_o; endmodule\nmodule u_dst_t; logic clk_i; endmodule\n' > %t/src/top.sv
// RUN: printf '#!/usr/bin/env python3\nimport pathlib, sys\ntarget = sys.argv[sys.argv.index("--target") + 1]\ntool = sys.argv[sys.argv.index("--tool") + 1]\nout_dir = pathlib.Path.cwd() / "build" / "fake" / f"{target}-{tool}"\nout_dir.mkdir(parents=True, exist_ok=True)\n(out_dir / "fake.eda.yml").write_text("""toplevel: top_earlgrey\\nfiles:\\n- name: %t/src/top.sv\\n  file_type: systemVerilogSource\\n""")\n' > %t/bin/fusesoc
// RUN: printf '#!/usr/bin/env python3\nimport json, pathlib, sys\nargs = sys.argv[1:]\ncases = pathlib.Path(args[args.index("--cases-file") + 1]).read_text().splitlines()\nresults = pathlib.Path(args[args.index("--results-file") + 1])\njsonl = pathlib.Path(args[args.index("--results-jsonl-file") + 1])\nrows = [line for line in cases if line.strip()]\nresults.write_text("".join(f"PASS\\t{line.split(chr(9))[0]}\\t/tmp/work\\topentitan-connectivity\\tCONNECTIVITY_BMC\\tUNSAT\\n" for line in rows))\njson_rows = []\nfor line in rows:\n  case_id = line.split(chr(9))[0]\n  json_rows.append({"schema_version":1,"suite":"opentitan-connectivity","mode":"CONNECTIVITY_BMC","case_id":case_id,"case_path":"/tmp/work","status":"PASS","reason_code":"UNSAT","stage":"result","solver":"z3","solver_time_ms":None,"frontend_time_ms":None,"log_path":"","artifact_dir":""})\njsonl.write_text("".join(json.dumps(row, sort_keys=True)+"\\n" for row in json_rows), encoding="utf-8")\n' > %t/bin/fake_pairwise.py
// RUN: chmod +x %t/run_opentitan_connectivity_circt_bmc.py %t/bin/fusesoc %t/bin/fake_pairwise.py
// RUN: python3 %t/run_opentitan_connectivity_circt_bmc.py --target-manifest %t/target.tsv --rules-manifest %t/rules.tsv --opentitan-root %t --workdir %t/work --rule-filter 'RULE_CLK' --fusesoc-bin %t/bin/fusesoc --pairwise-runner %t/bin/fake_pairwise.py --results-file %t/results.tsv --results-jsonl-file %t/results.jsonl
// RUN: python3 -c "import json; rows=[json.loads(line) for line in open('%t/results.jsonl', encoding='utf-8') if line.strip()]; assert len(rows)==1; row=rows[0]; assert row['suite']=='opentitan-connectivity'; assert row['mode']=='CONNECTIVITY_BMC'; assert row['status']=='PASS'; assert row['reason_code']=='UNSAT'"
