// RUN: rm -rf %t
// RUN: mkdir -p %t/utils %t/src %t/work
// RUN: cp %S/../../utils/run_opentitan_fpv_circt_bmc.py %t/utils/run_opentitan_fpv_circt_bmc.py
// RUN: printf '#!/usr/bin/env python3\nimport json,pathlib,sys\ncases=""\nout=""\njsonl=""\nargs=sys.argv[1:]\ni=0\nwhile i < len(args):\n  if args[i]=="--cases-file":\n    cases=args[i+1]; i+=2; continue\n  if args[i]=="--results-file":\n    out=args[i+1]; i+=2; continue\n  if args[i]=="--results-jsonl-file":\n    jsonl=args[i+1]; i+=2; continue\n  i+=1\nif not cases or not out or not jsonl:\n  raise SystemExit(10)\nrows=[line for line in pathlib.Path(cases).read_text(encoding=\"utf-8\").splitlines() if line.strip()]\nif len(rows)!=1:\n  raise SystemExit(11)\nparts=rows[0].split(\"\\t\")\ncase_id=parts[0]\ncase_path=parts[4]\npathlib.Path(out).write_text(f\"PASS\\t{case_id}\\t{case_path}\\topentitan\\tFPV_BMC\\tUNSAT\\n\", encoding=\"utf-8\")\npathlib.Path(jsonl).write_text(json.dumps({\"schema_version\":1,\"suite\":\"opentitan\",\"mode\":\"FPV_BMC\",\"case_id\":case_id,\"case_path\":case_path,\"status\":\"PASS\",\"reason_code\":\"UNSAT\",\"stage\":\"result\",\"solver\":\"z3\",\"solver_time_ms\":0,\"frontend_time_ms\":0,\"log_path\":\"/tmp/work/pairwise/circt-bmc.log\",\"artifact_dir\":\"/tmp/work/pairwise\"}, sort_keys=True)+\"\\n\", encoding=\"utf-8\")\n' > %t/utils/run_pairwise_circt_bmc.py
// RUN: chmod +x %t/utils/run_opentitan_fpv_circt_bmc.py %t/utils/run_pairwise_circt_bmc.py
// RUN: touch %t/src/foo.sv
// RUN: printf '#opentitan_compile_contract_schema_version=1\ntarget_name\tfusesoc_core\ttask\tflow\tsub_flow\trel_path\ttoplevel\tsetup_status\tfile_count\tinclude_dir_count\tdefine_count\tfiles_fingerprint\tinclude_dirs_fingerprint\tdefines_fingerprint\tcontract_fingerprint\tstopat_count\tstopats_fingerprint\tstopats\ttask_profile\ttask_known\tstopat_mode\tblackbox_policy\ttask_policy_fingerprint\tfiles\tinclude_dirs\tdefines\teda_yml_path\tsetup_log_path\tworkdir\nfoo_fpv\tlowrisc:fpv:foo_fpv\tFpvDefault\tformal\tfpv\thw/top_earlgrey/formal/ip/foo\tfoo_tb\tok\t1\t0\t0\tf\ti\td\tc\t0\ts\t\tfpv_default\t1\tnone\tnone\tp\t%t/src/foo.sv\t\t\t/tmp/foo.eda.yml\t/tmp/foo.log\t/tmp/foo.work\nbar_fpv\tlowrisc:fpv:bar_fpv\tFpvDefault\tformal\tfpv\thw/top_earlgrey/formal/ip/bar\tbar_tb\terror\t0\t0\t0\t\t\t\t\t0\ts\t\tfpv_default\t1\tnone\tnone\tp\t\t\t\t/tmp/bar.eda.yml\t/tmp/bar.log\t/tmp/bar.work\n' > %t/contracts.tsv
// RUN: not sh -c '%t/utils/run_opentitan_fpv_circt_bmc.py --compile-contracts %t/contracts.tsv --workdir %t/work --results-file %t/results.tsv --results-jsonl-file %t/results.jsonl' 2>&1 | FileCheck %s --check-prefix=LOG
// RUN: python3 -c "import json; rows=[json.loads(line) for line in open('%t/results.jsonl', encoding='utf-8') if line.strip()]; assert len(rows)==2; by_id={row['case_id']:row for row in rows}; assert by_id['foo_fpv::foo_tb']['status']=='PASS'; assert by_id['foo_fpv::foo_tb']['reason_code']=='UNSAT'; assert by_id['foo_fpv::foo_tb']['solver']=='z3'; assert by_id['foo_fpv::foo_tb']['frontend_time_ms']==0; assert by_id['foo_fpv::foo_tb']['solver_time_ms']==0; assert by_id['foo_fpv::foo_tb']['log_path']=='/tmp/work/pairwise/circt-bmc.log'; assert by_id['foo_fpv::foo_tb']['artifact_dir']=='/tmp/work/pairwise'; assert by_id['bar_fpv']['status']=='ERROR'; assert by_id['bar_fpv']['reason_code']=='COMPILE_CONTRACT_SETUP_ERROR'; assert by_id['bar_fpv']['frontend_time_ms']==0; assert by_id['bar_fpv']['solver_time_ms']==0"
//
// LOG: opentitan FPV BMC summary: total=2 pass=1 fail=0 xfail=0 xpass=0 error=1 skip=0
