// RUN: rm -rf %t
// RUN: mkdir -p %t/utils %t/bin %t/sv-tests %t/verilator %t/yosys %t/ot/hw/top_earlgrey/formal
// RUN: cp %S/../../utils/run_formal_all.sh %t/utils/run_formal_all.sh
// RUN: cp %S/../../utils/select_opentitan_formal_cfgs.py %t/utils/select_opentitan_formal_cfgs.py
// RUN: printf '#!/usr/bin/env python3\nimport csv\nimport pathlib\nimport sys\nout_contracts = \"\"\ntarget_filter = \"\"\nargs = sys.argv[1:]\nwhile args:\n  tok = args.pop(0)\n  if tok == \"--out-contracts\":\n    out_contracts = args.pop(0)\n  elif tok == \"--target-filter\":\n    target_filter = args.pop(0)\n  elif args:\n    if tok.startswith(\"--\"):\n      args.pop(0)\nif target_filter != \"^foo_fpv$\":\n  raise SystemExit(f\"missing_target_filter={target_filter}\")\nout = pathlib.Path(out_contracts)\nout.parent.mkdir(parents=True, exist_ok=True)\nwith out.open(\"w\", encoding=\"utf-8\", newline=\"\") as h:\n  h.write(\"#opentitan_compile_contract_schema_version=1\\n\")\n  w = csv.writer(h, delimiter=\"\\t\", lineterminator=\"\\n\")\n  w.writerow([\"target_name\", \"rel_path\", \"task_profile\", \"task_known\", \"setup_status\", \"stopat_mode\", \"stopat_count\", \"stopats\", \"blackbox_policy\", \"toplevel\", \"files\", \"include_dirs\", \"defines\"])\n  w.writerow([\"foo_fpv\", \"hw/top_earlgrey/formal/ip/foo\", \"fpv_default\", \"1\", \"ok\", \"none\", \"0\", \"\", \"none\", \"foo_tb\", \"foo.sv\", \"\", \"\"])\n' > %t/utils/resolve_opentitan_formal_compile_contracts.py
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\ncompile=\"\"\nfor ((i=1; i<=$#; ++i)); do\n  if [[ \"${!i}\" == \"--compile-contracts\" ]]; then\n    j=$((i+1)); compile=\"${!j}\"; break\n  fi\ndone\n: \"${compile:?}\"\nif grep -q \"bar_fpv\" \"$compile\"; then\n  echo \"unexpected_bar_fpv\" >&2\n  exit 22\nfi\ngrep -q \"foo_fpv\" \"$compile\" || { echo \"missing_foo_fpv\" >&2; exit 23; }\n: \"${OUT:?}\"\nprintf \"PASS\\tfoo_fpv::foo_tb\\t%t/out/opentitan-fpv-bmc-work/foo_fpv/foo_tb\\topentitan\\tFPV_BMC\\tUNSAT\\n\" > \"$OUT\"\n' > %t/utils/run_opentitan_fpv_circt_bmc.py
// RUN: printf '#!/usr/bin/env bash\nexit 0\n' > %t/bin/circt-verilog
// RUN: printf '#!/usr/bin/env bash\nexit 0\n' > %t/bin/circt-opt
// RUN: printf '#!/usr/bin/env bash\nexit 0\n' > %t/bin/circt-bmc
// RUN: printf '#!/usr/bin/env bash\nexit 0\n' > %t/bin/circt-lec
// RUN: printf '#!/usr/bin/env bash\nexit 0\n' > %t/bin/fusesoc
// RUN: printf '{\n  "name": "top_earlgrey_fpv_ip_cfgs",\n  "flow": "formal",\n  "sub_flow": "fpv",\n  "use_cfgs": [\n    {\n      "name": "foo_fpv",\n      "dut": "foo_tb",\n      "fusesoc_core": "lowrisc:fpv:foo_fpv",\n      "task": "FpvDefault",\n      "rel_path": "hw/top_earlgrey/formal/ip/foo"\n    },\n    {\n      "name": "bar_fpv",\n      "dut": "bar_tb",\n      "fusesoc_core": "lowrisc:fpv:bar_fpv",\n      "task": "FpvDefault",\n      "rel_path": "hw/top_earlgrey/formal/ip/bar"\n    }\n  ]\n}\n' > %t/ot/hw/top_earlgrey/formal/top_earlgrey_fpv_ip_cfgs.hjson
// RUN: chmod +x %t/utils/run_formal_all.sh %t/utils/select_opentitan_formal_cfgs.py %t/utils/resolve_opentitan_formal_compile_contracts.py %t/utils/run_opentitan_fpv_circt_bmc.py %t/bin/circt-verilog %t/bin/circt-opt %t/bin/circt-bmc %t/bin/circt-lec %t/bin/fusesoc
// RUN: cd %t && utils/run_formal_all.sh --out-dir %t/out --sv-tests %t/sv-tests --verilator %t/verilator --yosys %t/yosys --with-opentitan-fpv-bmc --opentitan %t/ot --circt-verilog %t/bin/circt-verilog --include-lane-regex '^opentitan/FPV_BMC$' --opentitan-fpv-cfg %t/ot/hw/top_earlgrey/formal/top_earlgrey_fpv_ip_cfgs.hjson --opentitan-fpv-target-filter '^foo_fpv$' --opentitan-fpv-fusesoc-bin %t/bin/fusesoc
// RUN: FileCheck %s --check-prefix=SUMMARY < %t/out/summary.tsv
// RUN: FileCheck %s --check-prefix=CASE < %t/out/opentitan-fpv-bmc-results.txt
//
// SUMMARY: opentitan{{[[:space:]]+}}FPV_BMC{{[[:space:]]+}}1{{[[:space:]]+}}1{{[[:space:]]+}}0
// CASE: PASS{{[[:space:]]+}}foo_fpv::foo_tb{{[[:space:]]+}}{{.*}}opentitan-fpv-bmc-work/foo_fpv/foo_tb{{[[:space:]]+}}opentitan{{[[:space:]]+}}FPV_BMC{{[[:space:]]+}}UNSAT
