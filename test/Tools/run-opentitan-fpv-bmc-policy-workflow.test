// RUN: rm -rf %t
// RUN: mkdir -p %t/utils %t/utils/opentitan_fpv_policy
// RUN: cp %S/../../utils/run_opentitan_fpv_bmc_policy_workflow.sh %t/utils/run_opentitan_fpv_bmc_policy_workflow.sh
// RUN: cp %S/../../utils/opentitan_fpv_policy/task_profile_status_presets.tsv %t/utils/opentitan_fpv_policy/task_profile_status_presets.tsv
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\n: \"${ARG_LOG:?}\"\n: > \"$ARG_LOG\"\nfor arg in \"$@\"; do\n  echo \"$arg\" >> \"$ARG_LOG\"\ndone\n' > %t/utils/fake-run-formal-all.sh
// RUN: chmod +x %t/utils/run_opentitan_fpv_bmc_policy_workflow.sh %t/utils/fake-run-formal-all.sh
// RUN: ARG_LOG=%t/update.args %t/utils/run_opentitan_fpv_bmc_policy_workflow.sh --run-formal-all %t/utils/fake-run-formal-all.sh update --out-dir %t/out-update --opentitan-fpv-cfg %t/cfg.hjson --select-cfgs foo_fpv
// RUN: FileCheck %s --check-prefix=UPDATE < %t/update.args
// RUN: ARG_LOG=%t/check.args %t/utils/run_opentitan_fpv_bmc_policy_workflow.sh --run-formal-all %t/utils/fake-run-formal-all.sh check --out-dir %t/out-check --opentitan-fpv-cfg %t/cfg.hjson --select-cfgs foo_fpv
// RUN: FileCheck %s --check-prefix=CHECK < %t/check.args
// RUN: ARG_LOG=%t/check-nostrict.args %t/utils/run_opentitan_fpv_bmc_policy_workflow.sh --run-formal-all %t/utils/fake-run-formal-all.sh --no-strict-gate check --out-dir %t/out-check-nostrict --opentitan-fpv-cfg %t/cfg.hjson --select-cfgs foo_fpv
// RUN: FileCheck %s --check-prefix=CHECK-NOSTRICT < %t/check-nostrict.args
// RUN: not rg -q -- '--strict-gate' %t/check-nostrict.args
// RUN: printf 'exact:retryable_exit_code_126\n' > %t/bmc-launch-allow.txt
// RUN: printf 'exact:retryable_exit_code_127\n' > %t/lec-launch-allow.txt
// RUN: printf 'exact:retryable_exit_code_126\t1\n' > %t/bmc-launch-budget.tsv
// RUN: printf 'exact:retryable_exit_code_127\t2\n' > %t/lec-launch-budget.tsv
// RUN: ARG_LOG=%t/check-launch.args %t/utils/run_opentitan_fpv_bmc_policy_workflow.sh --run-formal-all %t/utils/fake-run-formal-all.sh --check-bmc-launch-reason-key-allowlist-file %t/bmc-launch-allow.txt --check-lec-launch-reason-key-allowlist-file %t/lec-launch-allow.txt --check-max-bmc-launch-reason-event-rows 2 --check-max-lec-launch-reason-event-rows 3 --check-bmc-launch-reason-event-budget-file %t/bmc-launch-budget.tsv --check-lec-launch-reason-event-budget-file %t/lec-launch-budget.tsv --check-fail-on-any-bmc-launch-reason-events --check-fail-on-any-lec-launch-reason-events check --out-dir %t/out-check-launch --opentitan-fpv-cfg %t/cfg.hjson --select-cfgs foo_fpv
// RUN: FileCheck %s --check-prefix=CHECK-LAUNCH < %t/check-launch.args
// RUN: ARG_LOG=%t/check-cache.args %t/utils/run_opentitan_fpv_bmc_policy_workflow.sh --run-formal-all %t/utils/fake-run-formal-all.sh --opentitan-fpv-bmc-verilog-cache-mode readwrite --opentitan-fpv-bmc-verilog-cache-dir %t/cache check --out-dir %t/out-check-cache --opentitan-fpv-cfg %t/cfg.hjson --select-cfgs foo_fpv
// RUN: FileCheck %s --check-prefix=CACHE < %t/check-cache.args
// RUN: not sh -c '%t/utils/run_opentitan_fpv_bmc_policy_workflow.sh --run-formal-all %t/utils/fake-run-formal-all.sh update --out-dir %t/out-invalid --opentitan-fpv-cfg %t/cfg.hjson --select-cfgs foo_fpv --opentitan-fpv-bmc-summary-baseline-file %t/bad.tsv > %t/err.txt 2>&1'
// RUN: FileCheck %s --check-prefix=ERR < %t/err.txt
// RUN: not sh -c '%t/utils/run_opentitan_fpv_bmc_policy_workflow.sh --run-formal-all %t/utils/fake-run-formal-all.sh --opentitan-fpv-bmc-verilog-cache-mode bogus check --out-dir %t/out-bad-cache-mode --opentitan-fpv-cfg %t/cfg.hjson --select-cfgs foo_fpv > %t/err-cache-mode.txt 2>&1'
// RUN: FileCheck %s --check-prefix=ERR-CACHE-MODE < %t/err-cache-mode.txt
// RUN: not sh -c '%t/utils/run_opentitan_fpv_bmc_policy_workflow.sh --run-formal-all %t/utils/fake-run-formal-all.sh --opentitan-fpv-bmc-verilog-cache-dir %t/cache check --out-dir %t/out-bad-cache-dir --opentitan-fpv-cfg %t/cfg.hjson --select-cfgs foo_fpv > %t/err-cache-dir.txt 2>&1'
// RUN: FileCheck %s --check-prefix=ERR-CACHE-DIR < %t/err-cache-dir.txt
//
// UPDATE-DAG: --out-dir
// UPDATE-DAG: {{.*/}}out-update
// UPDATE-DAG: --opentitan-fpv-cfg
// UPDATE-DAG: {{.*/}}cfg.hjson
// UPDATE-DAG: --select-cfgs
// UPDATE-DAG: foo_fpv
// UPDATE-DAG: --with-opentitan-fpv-bmc
// UPDATE-DAG: --opentitan-fpv-bmc-assertion-status-policy-task-profile-presets-file
// UPDATE-DAG: {{.*/}}utils/opentitan_fpv_policy/task_profile_status_presets.tsv
// UPDATE-DAG: --opentitan-fpv-bmc-summary-baseline-file
// UPDATE-DAG: {{.*/}}utils/opentitan_fpv_policy/baselines/opentitan-fpv-bmc-fpv-summary-baseline.tsv
// UPDATE-DAG: --opentitan-fpv-bmc-assertion-results-baseline-file
// UPDATE-DAG: {{.*/}}utils/opentitan_fpv_policy/baselines/opentitan-fpv-bmc-assertion-results-baseline.tsv
// UPDATE-DAG: --opentitan-fpv-bmc-assertion-status-policy-grouped-violations-baseline-file
// UPDATE-DAG: {{.*/}}utils/opentitan_fpv_policy/baselines/opentitan-fpv-bmc-assertion-status-policy-grouped-violations-baseline.tsv
// UPDATE-DAG: --update-opentitan-fpv-bmc-summary-baseline
// UPDATE-DAG: --update-opentitan-fpv-bmc-assertion-results-baseline
// UPDATE-DAG: --update-opentitan-fpv-bmc-assertion-status-policy-grouped-violations-baseline
//
// CHECK-DAG: --fail-on-opentitan-fpv-bmc-summary-drift
// CHECK-DAG: --fail-on-opentitan-fpv-bmc-assertion-results-drift
// CHECK-DAG: --fail-on-opentitan-fpv-bmc-assertion-status-policy
// CHECK-DAG: --fail-on-opentitan-fpv-bmc-assertion-status-policy-grouped-violations-drift
// CHECK-DAG: --strict-gate
//
// CHECK-NOSTRICT-DAG: --fail-on-opentitan-fpv-bmc-summary-drift
// CHECK-NOSTRICT-DAG: --fail-on-opentitan-fpv-bmc-assertion-results-drift
// CHECK-NOSTRICT-DAG: --fail-on-opentitan-fpv-bmc-assertion-status-policy
// CHECK-NOSTRICT-DAG: --fail-on-opentitan-fpv-bmc-assertion-status-policy-grouped-violations-drift
//
// CHECK-LAUNCH-DAG: --bmc-launch-reason-key-allowlist-file
// CHECK-LAUNCH-DAG: {{.*/}}bmc-launch-allow.txt
// CHECK-LAUNCH-DAG: --lec-launch-reason-key-allowlist-file
// CHECK-LAUNCH-DAG: {{.*/}}lec-launch-allow.txt
// CHECK-LAUNCH-DAG: --max-bmc-launch-reason-event-rows
// CHECK-LAUNCH-DAG: 2
// CHECK-LAUNCH-DAG: --max-lec-launch-reason-event-rows
// CHECK-LAUNCH-DAG: 3
// CHECK-LAUNCH-DAG: --bmc-launch-reason-event-budget-file
// CHECK-LAUNCH-DAG: {{.*/}}bmc-launch-budget.tsv
// CHECK-LAUNCH-DAG: --lec-launch-reason-event-budget-file
// CHECK-LAUNCH-DAG: {{.*/}}lec-launch-budget.tsv
// CHECK-LAUNCH-DAG: --fail-on-any-bmc-launch-reason-events
// CHECK-LAUNCH-DAG: --fail-on-any-lec-launch-reason-events
//
// CACHE: --opentitan-fpv-bmc-verilog-cache-mode
// CACHE-NEXT: readwrite
// CACHE: --opentitan-fpv-bmc-verilog-cache-dir
// CACHE-NEXT: {{.*/}}cache
//
// ERR: workflow-managed option must not be passed explicitly: --opentitan-fpv-bmc-summary-baseline-file
// ERR-CACHE-MODE: invalid --opentitan-fpv-bmc-verilog-cache-mode: expected off|read|readwrite|auto
// ERR-CACHE-DIR: --opentitan-fpv-bmc-verilog-cache-dir requires --opentitan-fpv-bmc-verilog-cache-mode
