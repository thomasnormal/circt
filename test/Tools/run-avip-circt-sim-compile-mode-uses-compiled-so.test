// RUN: rm -rf %t
// RUN: mkdir -p %t/mbit/apb_avip/sim
// RUN: : > %t/mbit/apb_avip/sim/apb_compile.f
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\n: > "${OUT:?OUT is required}"\n' > %t/fake-run-avip.sh
// RUN: chmod +x %t/fake-run-avip.sh
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\norig=("$@")\nout=""\nwhile [[ $# -gt 0 ]]; do\n  case "$1" in\n    -o)\n      shift\n      out="${1:-}"\n      ;;\n  esac\n  shift || true\ndone\nif [[ -z "$out" ]]; then\n  echo "missing -o output path" >&2\n  exit 90\nfi\necho "${orig[*]}" > %t/compile-args.txt\nprintf "ok" > "$out"\n' > %t/fake-circt-compile
// RUN: chmod +x %t/fake-circt-compile
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\nmode=""\ncompiled=""\nfor arg in "$@"; do\n  if [[ "$arg" == --mode=* ]]; then\n    mode="${arg#--mode=}"\n  fi\n  if [[ "$arg" == --compiled=* ]]; then\n    compiled="${arg#--compiled=}"\n  fi\ndone\nif [[ "$mode" != "compile" ]]; then\n  echo "bad_mode=$mode" >&2\n  exit 91\nfi\nif [[ -z "$compiled" || ! -f "$compiled" ]]; then\n  echo "bad_compiled=$compiled" >&2\n  exit 92\nfi\necho "$*" > %t/sim-args.txt\necho "Simulation terminated at time 10 fs"\necho "UVM_FATAL : 0"\necho "UVM_ERROR : 0"\necho "Coverage = 100 %%%%"\necho "Coverage = 100 %%%%"\n' > %t/fake-circt-sim
// RUN: chmod +x %t/fake-circt-sim
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\nexit 0\n' > %t/fake-circt-verilog
// RUN: chmod +x %t/fake-circt-verilog
//
// RUN: env MBIT_DIR=%t/mbit AVIPS=apb SEEDS=1 CIRCT_SIM_MODE=compile CIRCT_VERILOG=%t/fake-circt-verilog CIRCT_SIM=%t/fake-circt-sim CIRCT_COMPILE=%t/fake-circt-compile CIRCT_ALLOW_NONCANONICAL_TOOLS=1 RUN_AVIP=%t/fake-run-avip.sh COMPILE_TIMEOUT=10 SIM_TIMEOUT=10 MAX_WALL_MS=1000 %S/../../utils/run_avip_circt_sim.sh %t/out > %t/log.txt 2>&1
// RUN: FileCheck %s --check-prefix=LOG < %t/log.txt
// RUN: FileCheck %s --check-prefix=COMPILE --match-full-lines < %t/compile-args.txt
// RUN: FileCheck %s --check-prefix=SIM < %t/sim-args.txt
// RUN: FileCheck %s --check-prefix=META < %t/out/meta.txt
// RUN: FileCheck %s --check-prefix=MATRIX < %t/out/matrix.tsv
//
// LOG: [avip-circt-sim] apb seed=1 sim_status=OK sim_exit=0
// COMPILE: {{^.*out/apb/apb\.mlir -o .*/out/apb/apb\.so$}}
// SIM: --mode=compile
// SIM: --compiled={{.*/out/apb/apb\.so}}
// META: circt_compile={{.*}}/.tool-snapshot/circt-compile
// META: circt_sim_mode=compile
// MATRIX: avip{{[[:space:]]+}}seed{{[[:space:]]+}}compile_status
// MATRIX: apb{{[[:space:]]+}}1{{[[:space:]]+}}OK{{[[:space:]]+}}[[COMPILE_SEC:[0-9]+]]{{[[:space:]]+}}OK{{[[:space:]]+}}0{{[[:space:]]+}}[[SIM_SEC:[0-9]+]]{{[[:space:]]+}}10{{[[:space:]]+}}0{{[[:space:]]+}}0{{[[:space:]]+}}100{{[[:space:]]+}}100
