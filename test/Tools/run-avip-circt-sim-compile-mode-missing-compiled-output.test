// RUN: rm -rf %t
// RUN: mkdir -p %t/mbit/apb_avip/sim
// RUN: : > %t/mbit/apb_avip/sim/apb_compile.f
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\n: > "${OUT:?OUT is required}"\n' > %t/fake-run-avip.sh
// RUN: chmod +x %t/fake-run-avip.sh
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\n# Intentionally succeed without creating the -o output.\nexit 0\n' > %t/fake-circt-compile
// RUN: chmod +x %t/fake-circt-compile
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\necho "sim_should_not_run" >&2\nexit 99\n' > %t/fake-circt-sim
// RUN: chmod +x %t/fake-circt-sim
// RUN: printf '#!/usr/bin/env bash\nset -euo pipefail\nexit 0\n' > %t/fake-circt-verilog
// RUN: chmod +x %t/fake-circt-verilog
//
// RUN: env MBIT_DIR=%t/mbit AVIPS=apb SEEDS=1 CIRCT_SIM_MODE=compile CIRCT_VERILOG=%t/fake-circt-verilog CIRCT_SIM=%t/fake-circt-sim CIRCT_COMPILE=%t/fake-circt-compile CIRCT_ALLOW_NONCANONICAL_TOOLS=1 RUN_AVIP=%t/fake-run-avip.sh COMPILE_TIMEOUT=10 SIM_TIMEOUT=10 MAX_WALL_MS=1000 %S/../../utils/run_avip_circt_sim.sh %t/out > %t/log.txt 2>&1
// RUN: FileCheck %s --check-prefix=LOG < %t/log.txt
// RUN: FileCheck %s --check-prefix=MATRIX < %t/out/matrix.tsv
// RUN: FileCheck %s --check-prefix=COMPILELOG < %t/out/apb/compile.log
//
// LOG: [avip-circt-sim] apb compile_status=FAIL
// MATRIX: avip{{[[:space:]]+}}seed{{[[:space:]]+}}compile_status
// MATRIX: apb{{[[:space:]]+}}1{{[[:space:]]+}}FAIL{{[[:space:]]+}}[[COMPILE_SEC:[0-9]+]]{{[[:space:]]+}}SKIP{{[[:space:]]+}}-
// COMPILELOG: [avip-circt-sim] error: circt-compile succeeded but produced no shared object:
