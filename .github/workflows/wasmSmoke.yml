name: WASM Smoke

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

jobs:
  wasm-smoke:
    name: Configure and Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Get CIRCT
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install ninja
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build

      - name: Run wasm script contract checks
        run: |
          utils/wasm_configure_behavior_check.sh
          utils/wasm_configure_behavior_contract_check.sh
          utils/wasm_configure_contract_check.sh
          utils/wasm_cxx20_contract_check.sh
          utils/wasm_cxx20_warning_contract_check.sh
          utils/wasm_runtime_helpers_behavior_check.sh
          utils/wasm_runtime_helpers_behavior_contract_check.sh
          utils/wasm_runtime_helpers_contract_check.sh
          utils/wasm_smoke_contract_check.sh
          utils/wasm_ci_contract_check.sh

      - name: Configure wasm build and run smoke checks
        run: |
          set -euo pipefail
          git clone --depth=1 https://github.com/emscripten-core/emsdk.git "$RUNNER_TEMP/emsdk"
          "$RUNNER_TEMP/emsdk/emsdk" install 4.0.12
          "$RUNNER_TEMP/emsdk/emsdk" activate 4.0.12
          source "$RUNNER_TEMP/emsdk/emsdk_env.sh"

          utils/configure_wasm_build.sh
          utils/wasm_cxx20_warning_behavior_check.sh
          BUILD_DIR=build-wasm NINJA_JOBS=1 utils/wasm_cxx20_warning_check.sh
          WASM_REQUIRE_VERILOG=1 WASM_REQUIRE_CLEAN_CROSSCOMPILE=1 \
            WASM_CHECK_CXX20_WARNINGS=1 NINJA_JOBS=1 \
            utils/run_wasm_smoke.sh

      - name: Browser-like wasm UVM harness (--expect-pass)
        run: |
          set -euo pipefail
          npm install --no-save --no-package-lock @playwright/test
          npx playwright install chromium
          node utils/repro_wasm_uvm_browser_assert.mjs --expect-pass

      - name: Re-run smoke checks without rebuild
        run: |
          WASM_REQUIRE_VERILOG=1 WASM_REQUIRE_CLEAN_CROSSCOMPILE=1 \
            WASM_CHECK_CXX20_WARNINGS=0 WASM_SKIP_BUILD=1 NINJA_JOBS=1 \
            utils/run_wasm_smoke.sh
