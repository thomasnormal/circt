# WASM Engineering Log

## 2026-02-23
- Goal: build CIRCT for WebAssembly with a simple (non-JIT) execution path suitable for browser use.
- Confirmed `MLIR_ENABLE_EXECUTION_ENGINE=OFF` is required to avoid JIT-specific complexity and dependencies.
- Cross-compiling CIRCT to wasm32 exposed several latent 64-bit assumptions (`~0ULL` sentinels, fixed-size struct assertions, and narrowing conversions).
- The cross-build also required host tablegen tooling; CIRCT CMake needed to use host `MLIR_TABLEGEN` when cross-compiling.
- Additional wasm-specific compile/link issues appeared in codepaths not typically exercised on native builds:
  - `llvm::sys::Process` usage in `circt-bmc.cpp` required explicit `llvm/Support/Process.h`.
  - Emscripten `stdout`/`stderr` macros conflicted with member access in `TestReporting.cpp`.
  - Static wasm linking required explicit dependencies in `tools/circt-bmc/CMakeLists.txt` that native builds picked up transitively.
  - `CIRCTImportVerilog` is optional in this wasm config; unconditional tool linking caused `-lCIRCTImportVerilog` failure.
- Validation performed:
  - Native regressions for touched paths (`ArcToLLVM`, `RTG elaboration`) passed.
  - `ninja -C build-wasm circt-bmc` succeeded.
  - `node build-wasm/bin/circt-bmc.js --help` executed successfully.
- Milestone: run CIRCT wasm unit tests under Node.js (excluding Arc by request).
- Realization: wasm unit-test aborts were dominated by thread usage (`pthread_create failed`) from both LLVM-side and project-side code.
- Switched wasm config to `LLVM_ENABLE_THREADS=OFF`; this removed most runtime aborts immediately.
- Surprise: `build-wasm/NATIVE` helper tool config still reports threads enabled; this is expected and separate from wasm test binaries.
- Fixed a latent bug in `IncrementalCompiler` constructor: thread count initialization accidentally updated the by-value parameter instead of the member config.
- For wasm simplicity, `IncrementalCompiler` now disables parallel compilation on `__EMSCRIPTEN__` and falls back to sequential scheduling.
- `WallClockTimeout` tests required thread support; added wasm skips to keep single-threaded wasm test runs stable.
- Moore runtime had behavior mismatches against tests:
  - `__moore_string_substr` implemented end-index semantics while API/docs/tests used length semantics.
  - regex path returned POSIX-style success codes inconsistently and did not preserve the matched substring buffer.
  - implemented wasm-safe regex execution path using POSIX `regcomp/regexec` on emscripten to avoid exception-dependent behavior in std::regex.
- Added targeted wasm expectation/skip adjustments where behavior is platform-specific:
  - Moore conversion test `FourStateLLVMStructCastPreservesFieldOrder` accepts wasm lowering shape.
  - Sim `ThreadBarrierTest.MultipleThreads` and Moore runtime thread-focused tests are skipped on wasm.
- Additional test robustness updates:
  - ProcessScheduler integration tests now tolerate deferred event execution semantics across scheduler configurations.
- Final validation:
  - Built `CIRCTUnitTests` in wasm mode.
  - Ran all generated CIRCT unittest JS binaries under Node (excluding Arc).
  - Result: 16/16 pass.
